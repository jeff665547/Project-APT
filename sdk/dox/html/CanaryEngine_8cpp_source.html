<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Affymetrix Power Tools: canary/CanaryEngine.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="dir_9a2b6b842d2bc0fb57935a5fbc13292d.html">canary</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>CanaryEngine.cpp</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">////////////////////////////////////////////////////////////////</span>
<a name="l00002"></a>00002 <span class="comment"></span><span class="comment">//</span>
<a name="l00003"></a>00003 <span class="comment">// Copyright (C) 1989, 1991 Free Software Foundation, Inc.</span>
<a name="l00004"></a>00004 <span class="comment">//</span>
<a name="l00005"></a>00005 <span class="comment">// This program is free software; you can redistribute it and/or modify </span>
<a name="l00006"></a>00006 <span class="comment">// it under the terms of the GNU General Public License (version 2) as </span>
<a name="l00007"></a>00007 <span class="comment">// published by the Free Software Foundation.</span>
<a name="l00008"></a>00008 <span class="comment">// </span>
<a name="l00009"></a>00009 <span class="comment">// This program is distributed in the hope that it will be useful, </span>
<a name="l00010"></a>00010 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of </span>
<a name="l00011"></a>00011 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU </span>
<a name="l00012"></a>00012 <span class="comment">// General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment">// </span>
<a name="l00014"></a>00014 <span class="comment">// You should have received a copy of the GNU General Public License </span>
<a name="l00015"></a>00015 <span class="comment">// along with this program;if not, write to the </span>
<a name="l00016"></a>00016 <span class="comment">// </span>
<a name="l00017"></a>00017 <span class="comment">// Free Software Foundation, Inc., </span>
<a name="l00018"></a>00018 <span class="comment">// 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<a name="l00019"></a>00019 <span class="comment">//</span><span class="comment"></span>
<a name="l00020"></a>00020 <span class="comment">////////////////////////////////////////////////////////////////</span>
<a name="l00021"></a>00021 <span class="comment"></span>
<a name="l00022"></a>00022 <span class="comment">//</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="CanaryEngine_8h.html" title="Give a brief description of Canary.">canary/CanaryEngine.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="comment">//</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;canary/CanaryOptions.h&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;canary/CanaryWithPrior.h&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;canary/canary_utils.h&quot;</span>
<a name="l00028"></a>00028 <span class="comment">//</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="ProbeSetMultiDataData_8h.html">calvin_files/data/src/ProbeSetMultiDataData.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="FusionCELData_8h.html">calvin_files/fusion/src/FusionCELData.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="StringUtils_8h.html">calvin_files/utils/src/StringUtils.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="CalvinCHPMultiDataFileWriter_8h.html">calvin_files/writers/src/CalvinCHPMultiDataFileWriter.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="DiskIntensityMart_8h.html" title="Class for encapsulating microarray data and storing it on disk in a reasonable way to reduce memory i...">chipstream/DiskIntensityMart.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="EngineUtil_8h.html" title="Some common functions that application executables make use of.">chipstream/EngineUtil.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="IntensityMart_8h.html" title="Base class for ojbects that will dispense data on a [feature,chip] level.">chipstream/IntensityMart.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="SparseMart_8h.html" title="Class for representing cel file intensity data in memory. Can save a lot of the space if not all of a...">chipstream/SparseMart.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="TsvFile_8h.html" title="Headers for the TsvFile classes.">file/TsvFile/TsvFile.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="Fs_8h.html" title="///">util/Fs.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="Util_8h.html" title="General Utilities.">util/Util.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="comment">//</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;newmat.h&quot;</span>
<a name="l00042"></a>00042 <span class="comment">//</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;cmath&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;cstdio&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;cstring&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;ctime&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;map&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;valarray&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="keyword">using namespace </span>std;
<a name="l00054"></a>00054 <span class="keyword">using namespace </span>affx;
<a name="l00055"></a>00055 <span class="keyword">using namespace </span>affymetrix_calvin_exceptions;
<a name="l00056"></a>00056 <span class="keyword">using namespace </span>affymetrix_fusion_io;
<a name="l00057"></a>00057 <span class="keyword">using namespace </span>affymetrix_calvin_io;
<a name="l00058"></a>00058 <span class="keyword">using namespace </span>affymetrix_calvin_data;
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <a class="code" href="classCanaryEngine_1_1Reg.html">CanaryEngine::Reg</a> <a class="code" href="classCanaryEngine.html#a157efbe704d35af724ce559faecc552a">CanaryEngine::reg</a>;
<a name="l00061"></a>00061 
<a name="l00062"></a><a class="code" href="classCanaryEngine.html#a9ac34503c7f35d277214819cbb8c05b0">00062</a> <a class="code" href="classCanaryEngine.html">CanaryEngine</a>* <a class="code" href="classCanaryEngine.html#a9ac34503c7f35d277214819cbb8c05b0">CanaryEngine::FromBase</a>(<a class="code" href="classBaseEngine.html" title="Base class for analysis engines.">BaseEngine</a> *engine) {
<a name="l00063"></a>00063     <span class="keywordflow">if</span> (engine != NULL &amp;&amp; engine-&gt;getEngineName() == CanaryEngine::EngineName())
<a name="l00064"></a>00064         <span class="keywordflow">return</span> (<a class="code" href="classCanaryEngine.html">CanaryEngine</a> *)engine;
<a name="l00065"></a>00065     <span class="keywordflow">return</span> NULL;
<a name="l00066"></a>00066 }
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="classCanaryEngine.html#a186b6072400bc681d9fd16a45acbb720">00068</a> <a class="code" href="classCanaryEngine.html#a186b6072400bc681d9fd16a45acbb720" title="Constructor.">CanaryEngine::CanaryEngine</a>() {
<a name="l00069"></a>00069     defineOptions();
<a name="l00070"></a>00070 }
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="classCanaryEngine.html#a850d73a0458e77e9d2fb5955c25c2056">00072</a> <a class="code" href="classCanaryEngine.html#a850d73a0458e77e9d2fb5955c25c2056" title="Destructor.">CanaryEngine::~CanaryEngine</a>() {
<a name="l00073"></a>00073 }
<a name="l00074"></a>00074 <span class="comment"></span>
<a name="l00075"></a>00075 <span class="comment">/** Fill in options given command line arguments. */</span>
<a name="l00076"></a>00076 <span class="keywordtype">void</span> CanaryEngine::fillInOptions(<a class="code" href="classCanaryOptions.html" title="Place to group program options.">CanaryOptions</a> &amp;o) {
<a name="l00077"></a>00077     o.version = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;program-version&quot;</span>);
<a name="l00078"></a>00078     o.cvsId = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;program-cvs-id&quot;</span>);
<a name="l00079"></a>00079     o.progName = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;program-name&quot;</span>);
<a name="l00080"></a>00080     o.progName = <a class="code" href="classFs.html#a16925724086de1c12ea58bad4f8df75c" title="like the unix function of the same name. ///">Fs::basename</a>(o.progName);
<a name="l00081"></a>00081     o.execGuid = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;exec-guid&quot;</span>);
<a name="l00082"></a>00082     o.timeStr = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;time-start&quot;</span>);
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     o.genomeVersion = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;genome-version&quot;</span>);
<a name="l00085"></a>00085     o.mapName = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;map-name&quot;</span>);
<a name="l00086"></a>00086     o.mapVersion = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;map-version&quot;</span>);
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     o.force = <a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;force&quot;</span>);
<a name="l00089"></a>00089     o.precision = <a class="code" href="classOptions.html#afcfab86e21cac5bba43e0858bd428e62" title="Get the integer value of an option.">getOptInt</a>(<span class="stringliteral">&quot;precision&quot;</span>);
<a name="l00090"></a>00090     o.verbosity = <a class="code" href="classOptions.html#afcfab86e21cac5bba43e0858bd428e62" title="Get the integer value of an option.">getOptInt</a>(<span class="stringliteral">&quot;verbose&quot;</span>);
<a name="l00091"></a>00091     o.cdfFile = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cdf-file&quot;</span>);
<a name="l00092"></a>00092     o.spfFile = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;spf-file&quot;</span>);
<a name="l00093"></a>00093     o.outDir = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;out-dir&quot;</span>);
<a name="l00094"></a>00094     o.cnvRegionFile = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cnv-region-file&quot;</span>);
<a name="l00095"></a>00095     o.cnvMapFile = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cnv-map-file&quot;</span>);
<a name="l00096"></a>00096     o.canaryPriorFile = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cnv-prior-file&quot;</span>);
<a name="l00097"></a>00097     o.cnvNormFile = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cnv-normalization-file&quot;</span>);
<a name="l00098"></a>00098     o.setAnalysisName = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;analysis-name&quot;</span>);
<a name="l00099"></a>00099     o.ccMDChpOutput = <a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;cc-chp-output&quot;</span>);
<a name="l00100"></a>00100     o.tableOutput = <a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;table-output&quot;</span>);
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     o.chipType = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;chip-type&quot;</span>);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     <a class="code" href="classUtil.html#a21a08a463a4b0b321b58979b0404e017" title="Chop off the last character if it is a path separator.">Util::chompLastIfSep</a>(o.outDir); <span class="comment">// for windows</span>
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     <span class="keywordflow">if</span> (<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;apt-summarize-analysis&quot;</span>) != <span class="stringliteral">&quot;&quot;</span>)
<a name="l00107"></a>00107         o.aptSummarizeAnalysis = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;apt-summarize-analysis&quot;</span>);
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     <span class="keywordflow">if</span> (<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;apt-canary-analysis&quot;</span>) != <span class="stringliteral">&quot;&quot;</span>)
<a name="l00110"></a>00110         o.aptCanaryAnalysis = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;apt-canary-analysis&quot;</span>);
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     o.<a class="code" href="classCanaryOptions.html#a9e2925bcefd1829244322a6fc5ffa3de" title="CHP files to analyze.">chpFiles</a> = <a class="code" href="classOptions.html#ab20d0083424d9d9a8b94da46f487f57a" title="Return a vector of values for a particular option.">getOptVector</a>(<span class="stringliteral">&quot;result-files&quot;</span>);
<a name="l00113"></a>00113     o.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a> = <a class="code" href="classOptions.html#ab20d0083424d9d9a8b94da46f487f57a" title="Return a vector of values for a particular option.">getOptVector</a>(<span class="stringliteral">&quot;cels&quot;</span>);
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     <span class="comment">// Get CEL file GUIDs</span>
<a name="l00116"></a>00116     o.<a class="code" href="classCanaryOptions.html#a86e37b85224cebcb7be4d0eef201b336" title="Cel files to analyze.">celGuids</a>.resize(o.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>.size());
<a name="l00117"></a>00117     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> chip=0; chip&lt;o.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>.size(); chip++) {
<a name="l00118"></a>00118         <a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html">FusionCELData</a> cel;
<a name="l00119"></a>00119         <span class="keywordflow">try</span> {
<a name="l00120"></a>00120             cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#af43c5c7a95f9f535883c1ddda0bea057">SetFileName</a>(o.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>[chip].c_str());
<a name="l00121"></a>00121             <span class="keywordflow">if</span> (!cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#aca791993ba594e5a424ece9cd0bfc54e">ReadHeader</a>()) {
<a name="l00122"></a>00122                 <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Unable to read CEL file &quot;</span> + o.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>[chip]);
<a name="l00123"></a>00123             }
<a name="l00124"></a>00124             <a class="code" href="classaffymetrix__calvin__io_1_1GenericData.html">GenericData</a> *gdata = cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a5fa95da46ae88e9ab8a85e69a73f198d">GetGenericData</a>();
<a name="l00125"></a>00125             <span class="keywordflow">if</span> (gdata != NULL) {
<a name="l00126"></a>00126                 o.<a class="code" href="classCanaryOptions.html#a86e37b85224cebcb7be4d0eef201b336" title="Cel files to analyze.">celGuids</a>[chip] = gdata-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1GenericData.html#aa4dde02ef7050992a36bcd7c2c231c29">Header</a>().GetGenericDataHdr()-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1GenericDataHeader.html#a11f21dee83156bb33470bc9475ef78c0">GetFileId</a>();
<a name="l00127"></a>00127             }
<a name="l00128"></a>00128             cel.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#ae5e091bf0e0549f45f45ba55221fea31">Close</a>();
<a name="l00129"></a>00129         }
<a name="l00130"></a>00130         <span class="keywordflow">catch</span> (...) {
<a name="l00131"></a>00131             <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Unable to read CEL file &quot;</span> + o.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>[chip]);
<a name="l00132"></a>00132         }
<a name="l00133"></a>00133     }
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     <span class="keywordflow">return</span>;
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="keywordtype">void</span> CanaryEngine::extraHelp() {
<a name="l00140"></a>00140     cout &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00141"></a>00141     cout &lt;&lt; <span class="stringliteral">&quot;Canary Parameters:\n&quot;</span>;
<a name="l00142"></a>00142     cout &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00143"></a>00143     cout &lt;&lt; <span class="stringliteral">&quot;    The canary algorithm does copy number calling on defined\n&quot;</span>;
<a name="l00144"></a>00144     cout &lt;&lt; <span class="stringliteral">&quot;    regions using priors. The following parameters are \n&quot;</span>;
<a name="l00145"></a>00145     cout &lt;&lt; <span class="stringliteral">&quot;    accessible using the --apt-canary-analysis option.\n&quot;</span>;
<a name="l00146"></a>00146     cout &lt;&lt; <span class="stringliteral">&quot;    Use key1=val1,key2=val2,... string format.\n&quot;</span>;
<a name="l00147"></a>00147     cout &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00148"></a>00148     cout &lt;&lt; <span class="stringliteral">&quot;        af-weight \n&quot;</span>;
<a name="l00149"></a>00149     cout &lt;&lt; <span class="stringliteral">&quot;        TOL \n&quot;</span>;
<a name="l00150"></a>00150     cout &lt;&lt; <span class="stringliteral">&quot;        hwe_tol \n&quot;</span>;
<a name="l00151"></a>00151     cout &lt;&lt; <span class="stringliteral">&quot;        hwe_tol2 \n&quot;</span>;
<a name="l00152"></a>00152     cout &lt;&lt; <span class="stringliteral">&quot;        fraction-giveaway-0 \n&quot;</span>;
<a name="l00153"></a>00153     cout &lt;&lt; <span class="stringliteral">&quot;        fraction-giveaway-1 \n&quot;</span>;
<a name="l00154"></a>00154     cout &lt;&lt; <span class="stringliteral">&quot;        fraction-giveaway-2 \n&quot;</span>;
<a name="l00155"></a>00155     cout &lt;&lt; <span class="stringliteral">&quot;        fraction-giveaway-3 \n&quot;</span>;
<a name="l00156"></a>00156     cout &lt;&lt; <span class="stringliteral">&quot;        fraction-giveaway-4 \n&quot;</span>;
<a name="l00157"></a>00157     cout &lt;&lt; <span class="stringliteral">&quot;        min-fill-prop \n&quot;</span>;
<a name="l00158"></a>00158     cout &lt;&lt; <span class="stringliteral">&quot;        conf-interval-half-width \n&quot;</span>;
<a name="l00159"></a>00159     cout &lt;&lt; <span class="stringliteral">&quot;        inflation \n&quot;</span>;
<a name="l00160"></a>00160     cout &lt;&lt; <span class="stringliteral">&quot;        min-cluster-variance \n&quot;</span>;
<a name="l00161"></a>00161     cout &lt;&lt; <span class="stringliteral">&quot;        pseudopoint-factor \n&quot;</span>;
<a name="l00162"></a>00162     cout &lt;&lt; <span class="stringliteral">&quot;        regularize_variance_factor \n&quot;</span>;
<a name="l00163"></a>00163     cout &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00164"></a>00164 }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 <span class="keywordtype">void</span> CanaryEngine::defineOptions() {
<a name="l00167"></a>00167     <span class="comment">// Input options</span>
<a name="l00168"></a>00168     defineOptionSection(<span class="stringliteral">&quot;Input Options&quot;</span>);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;cel-files&quot;</span>, PgOpt::STRING_OPT, 
<a name="l00171"></a>00171                  <span class="stringliteral">&quot;Text file specifying cel files to process, one per line with the first line being &#39;cel_files&#39;.&quot;</span>, 
<a name="l00172"></a>00172                  <span class="stringliteral">&quot;&quot;</span>);
<a name="l00173"></a>00173     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;cdf-file&quot;</span>, PgOpt::STRING_OPT, 
<a name="l00174"></a>00174                  <span class="stringliteral">&quot;File defining probe sets. Use either --cdf-file or --spf-file &quot;</span>, 
<a name="l00175"></a>00175                  <span class="stringliteral">&quot;&quot;</span>);
<a name="l00176"></a>00176     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;spf-file&quot;</span>, PgOpt::STRING_OPT,
<a name="l00177"></a>00177                  <span class="stringliteral">&quot;File defining probe sets in spf (simple probe format) which is like a text cdf file.&quot;</span>,
<a name="l00178"></a>00178                  <span class="stringliteral">&quot;&quot;</span>);
<a name="l00179"></a>00179     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;cnv-region-file&quot;</span>, PgOpt::STRING_OPT,
<a name="l00180"></a>00180                  <span class="stringliteral">&quot;File defining CNV regions and what probesets to use for each CNV region.&quot;</span>, 
<a name="l00181"></a>00181                  <span class="stringliteral">&quot;&quot;</span>);
<a name="l00182"></a>00182     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;cnv-prior-file&quot;</span>, PgOpt::STRING_OPT,
<a name="l00183"></a>00183                  <span class="stringliteral">&quot;File defining the canary priors for a given CNV regions file.&quot;</span>, 
<a name="l00184"></a>00184                  <span class="stringliteral">&quot;&quot;</span>);
<a name="l00185"></a>00185     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;cnv-map-file&quot;</span>, PgOpt::STRING_OPT,
<a name="l00186"></a>00186                  <span class="stringliteral">&quot;File (bed format) used for visualizing CNV regions in other applications. This arg causes the map file name to be included in the CHP meta info.&quot;</span>, 
<a name="l00187"></a>00187                  <span class="stringliteral">&quot;&quot;</span>);
<a name="l00188"></a>00188     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;cnv-normalization-file&quot;</span>, PgOpt::STRING_OPT,
<a name="l00189"></a>00189                  <span class="stringliteral">&quot;File containing probesets to use (restricted to) for doing probe level normalization.&quot;</span>, 
<a name="l00190"></a>00190                  <span class="stringliteral">&quot;&quot;</span>);
<a name="l00191"></a>00191     defOptMult(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;chip-type&quot;</span>, PgOpt::STRING_OPT,
<a name="l00192"></a>00192                <span class="stringliteral">&quot;Chip types to check library and CEL files against. &quot;</span>
<a name="l00193"></a>00193                <span class="stringliteral">&quot;Can be specified multiple times. &quot;</span>
<a name="l00194"></a>00194                <span class="stringliteral">&quot;The first one is propigated as the chip type in the output files. &quot;</span>
<a name="l00195"></a>00195                <span class="stringliteral">&quot;Warning, use of this option will override the usual check between chip types &quot;</span>
<a name="l00196"></a>00196                <span class="stringliteral">&quot;found in the library files and cel files. You should use this option instead &quot;</span>
<a name="l00197"></a>00197                <span class="stringliteral">&quot;of --force when possible. &quot;</span>,
<a name="l00198"></a>00198                <span class="stringliteral">&quot;&quot;</span>);
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     <span class="comment">// Output options</span>
<a name="l00202"></a>00202     defineOptionSection(<span class="stringliteral">&quot;Output Options&quot;</span>);
<a name="l00203"></a>00203 
<a name="l00204"></a>00204     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;table-output&quot;</span>, PgOpt::BOOL_OPT,
<a name="l00205"></a>00205                  <span class="stringliteral">&quot;Output matching matrices of tab delimited genotype calls and confidences.&quot;</span>, <span class="stringliteral">&quot;true&quot;</span>);
<a name="l00206"></a>00206     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;cc-chp-output&quot;</span>, PgOpt::BOOL_OPT,
<a name="l00207"></a>00207                  <span class="stringliteral">&quot;Output resulting calls in binary CHP format. &quot;</span>
<a name="l00208"></a>00208                  <span class="stringliteral">&quot;This makes one AGCC Multi Data CHP file per cel file analyzed.&quot;</span>, <span class="stringliteral">&quot;false&quot;</span>);
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="comment">// Analysis options</span>
<a name="l00211"></a>00211     defineOptionSection(<span class="stringliteral">&quot;Analysis Options&quot;</span>);
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;apt-summarize-analysis&quot;</span>, PgOpt::STRING_OPT,
<a name="l00214"></a>00214                  <span class="stringliteral">&quot;String representing analysis parameters for the &quot;</span>
<a name="l00215"></a>00215                  <span class="stringliteral">&quot;apt-probeset-summarize step a.k.a. pre-canary&quot;</span>,
<a name="l00216"></a>00216                  <span class="stringliteral">&quot;&quot;</span>);
<a name="l00217"></a>00217     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;apt-canary-analysis&quot;</span>, PgOpt::STRING_OPT,
<a name="l00218"></a>00218                  <span class="stringliteral">&quot;String representing analysis parameters for canary.&quot;</span>,
<a name="l00219"></a>00219                  <span class="stringliteral">&quot;&quot;</span>);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="comment">// Execution control options</span>
<a name="l00222"></a>00222     defineOptionSection(<span class="stringliteral">&quot;Execution Control Options&quot;</span>);
<a name="l00223"></a>00223 
<a name="l00224"></a>00224     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;precision&quot;</span>, PgOpt::INT_OPT,
<a name="l00225"></a>00225                  <span class="stringliteral">&quot;Precision after decimal place&quot;</span>, <span class="stringliteral">&quot;4&quot;</span>);
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;analysis-name&quot;</span>, PgOpt::STRING_OPT,
<a name="l00228"></a>00228                  <span class="stringliteral">&quot;Set the name of the analysis.&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00229"></a>00229     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;use-disk&quot;</span>, PgOpt::BOOL_OPT,
<a name="l00230"></a>00230                  <span class="stringliteral">&quot;Store CEL intensities to be analyzed on disk.&quot;</span>, <span class="stringliteral">&quot;true&quot;</span>);
<a name="l00231"></a>00231     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;disk-cache&quot;</span>, PgOpt::INT_OPT,
<a name="l00232"></a>00232                  <span class="stringliteral">&quot;Size of intensity memory cache in millions of intensities (when --use-disk=true).&quot;</span>,
<a name="l00233"></a>00233                  <span class="stringliteral">&quot;50&quot;</span>);
<a name="l00234"></a>00234 
<a name="l00235"></a>00235     defineOptionSection(<span class="stringliteral">&quot;Engine Options (Not used on command line)&quot;</span>);
<a name="l00236"></a>00236     defOptMult(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;cels&quot;</span>, PgOpt::STRING_OPT,
<a name="l00237"></a>00237                <span class="stringliteral">&quot;Cel files to process.&quot;</span>,
<a name="l00238"></a>00238                <span class="stringliteral">&quot;&quot;</span>);
<a name="l00239"></a>00239     defOptMult(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;result-files&quot;</span>, PgOpt::STRING_OPT,
<a name="l00240"></a>00240                <span class="stringliteral">&quot;CHP file names to output. Must be paired with cels.&quot;</span>,
<a name="l00241"></a>00241                <span class="stringliteral">&quot;&quot;</span>);
<a name="l00242"></a>00242 }
<a name="l00243"></a>00243 
<a name="l00244"></a>00244 <span class="keywordtype">void</span> CanaryEngine::defineStates() {
<a name="l00245"></a>00245     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;num-rows&quot;</span>, PgOpt::INT_OPT,
<a name="l00246"></a>00246                  <span class="stringliteral">&quot;The number of rows on the chip.&quot;</span>,
<a name="l00247"></a>00247                  <span class="stringliteral">&quot;-1&quot;</span>);
<a name="l00248"></a>00248     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;num-cols&quot;</span>, PgOpt::INT_OPT,
<a name="l00249"></a>00249                  <span class="stringliteral">&quot;The number of cols on the chip.&quot;</span>,
<a name="l00250"></a>00250                  <span class="stringliteral">&quot;-1&quot;</span>);
<a name="l00251"></a>00251     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;probe-count&quot;</span>, PgOpt::INT_OPT,
<a name="l00252"></a>00252                  <span class="stringliteral">&quot;The number of probes on the chip.&quot;</span>,
<a name="l00253"></a>00253                  <span class="stringliteral">&quot;-1&quot;</span>);
<a name="l00254"></a>00254     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;channel-count&quot;</span>, PgOpt::INT_OPT,
<a name="l00255"></a>00255                  <span class="stringliteral">&quot;The number of data channels on the chip.&quot;</span>,
<a name="l00256"></a>00256                  <span class="stringliteral">&quot;-1&quot;</span>);
<a name="l00257"></a>00257     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;map-name&quot;</span>, PgOpt::STRING_OPT,
<a name="l00258"></a>00258                  <span class="stringliteral">&quot;The map label&quot;</span>,
<a name="l00259"></a>00259                  <span class="stringliteral">&quot;&quot;</span>);
<a name="l00260"></a>00260     defineOption(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;map-version&quot;</span>, PgOpt::STRING_OPT,
<a name="l00261"></a>00261                  <span class="stringliteral">&quot;Version of the map file.&quot;</span>,
<a name="l00262"></a>00262                  <span class="stringliteral">&quot;&quot;</span>);
<a name="l00263"></a>00263     defineOption(<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;genome-version&quot;</span>, PgOpt::STRING_OPT,
<a name="l00264"></a>00264                  <span class="stringliteral">&quot;The version of the genome.&quot;</span>,
<a name="l00265"></a>00265                  <span class="stringliteral">&quot;&quot;</span>);
<a name="l00266"></a>00266 }
<a name="l00267"></a>00267 <span class="comment"></span>
<a name="l00268"></a>00268 <span class="comment">/**</span>
<a name="l00269"></a>00269 <span class="comment"> * Make sure that our options are sane. Call Err::errAbort if not.</span>
<a name="l00270"></a>00270 <span class="comment"> * @param opts - Options to be checked.</span>
<a name="l00271"></a>00271 <span class="comment"> */</span>
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 <span class="keywordtype">void</span> CanaryEngine::checkOptionsImp() {
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     defineStates();
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     <a class="code" href="classBaseEngine.html#a90a5cba41ed5a3fe1b2fb9dc2896c696" title="Swap the option value to include the full path if found.">setLibFileOpt</a>(<span class="stringliteral">&quot;cdf-file&quot;</span>);
<a name="l00278"></a>00278     <a class="code" href="classBaseEngine.html#a90a5cba41ed5a3fe1b2fb9dc2896c696" title="Swap the option value to include the full path if found.">setLibFileOpt</a>(<span class="stringliteral">&quot;spf-file&quot;</span>);
<a name="l00279"></a>00279     <a class="code" href="classBaseEngine.html#a90a5cba41ed5a3fe1b2fb9dc2896c696" title="Swap the option value to include the full path if found.">setLibFileOpt</a>(<span class="stringliteral">&quot;cnv-region-file&quot;</span>);
<a name="l00280"></a>00280     <a class="code" href="classBaseEngine.html#a90a5cba41ed5a3fe1b2fb9dc2896c696" title="Swap the option value to include the full path if found.">setLibFileOpt</a>(<span class="stringliteral">&quot;cnv-prior-file&quot;</span>);
<a name="l00281"></a>00281     <a class="code" href="classBaseEngine.html#a90a5cba41ed5a3fe1b2fb9dc2896c696" title="Swap the option value to include the full path if found.">setLibFileOpt</a>(<span class="stringliteral">&quot;cnv-normalization-file&quot;</span>);
<a name="l00282"></a>00282 
<a name="l00283"></a>00283     <span class="keywordflow">if</span> (<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;out-dir&quot;</span>) == <span class="stringliteral">&quot;&quot;</span>) {
<a name="l00284"></a>00284         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Must specify an output directory.&quot;</span>);
<a name="l00285"></a>00285     }
<a name="l00286"></a>00286     <span class="keywordflow">if</span> (<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;temp-dir&quot;</span>) == <span class="stringliteral">&quot;&quot;</span>) { 
<a name="l00287"></a>00287       <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;temp-dir&quot;</span>,<a class="code" href="classFs.html#af44351abee4cbc47f94b83cb2f62899f" title="join strings with the path sep. /// while we would want people to keep the path with FsPath...">Fs::join</a>(<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;out-dir&quot;</span>),<span class="stringliteral">&quot;temp&quot;</span>));
<a name="l00288"></a>00288     }
<a name="l00289"></a>00289 
<a name="l00290"></a>00290     <span class="keywordflow">if</span> (<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cdf-file&quot;</span>) == <span class="stringliteral">&quot;&quot;</span> &amp;&amp; <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;spf-file&quot;</span>) == <span class="stringliteral">&quot;&quot;</span>)
<a name="l00291"></a>00291         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Must specify either a cdf file or spf file.&quot;</span>);
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <span class="comment">/* Read in cel file list from other file if specified. */</span>
<a name="l00294"></a>00294     vector&lt;string&gt; celFiles;
<a name="l00295"></a>00295     EngineUtil::getCelFiles(celFiles, <span class="keyword">this</span>);
<a name="l00296"></a>00296     <span class="keywordflow">if</span> (celFiles.size() == 0)
<a name="l00297"></a>00297         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;No cel files specified.&quot;</span>);
<a name="l00298"></a>00298     <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;cels&quot;</span>,celFiles);
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     vector&lt;string&gt; resultFiles = <a class="code" href="classOptions.html#ab20d0083424d9d9a8b94da46f487f57a" title="Return a vector of values for a particular option.">getOptVector</a>(<span class="stringliteral">&quot;result-files&quot;</span>);
<a name="l00301"></a>00301     <span class="keywordflow">if</span> (resultFiles.size() &gt; 0 &amp;&amp; celFiles.size() != resultFiles.size()) {
<a name="l00302"></a>00302         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;result-files option used but is not the same size as cel file listing&quot;</span>);
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305     <span class="keywordflow">if</span> (<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cnv-region-file&quot;</span>) == <span class="stringliteral">&quot;&quot;</span>)
<a name="l00306"></a>00306         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Must specify a CNV region file&quot;</span>);
<a name="l00307"></a>00307     <span class="keywordflow">if</span> (<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cnv-normalization-file&quot;</span>) == <span class="stringliteral">&quot;&quot;</span>)
<a name="l00308"></a>00308         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Must specify normalization file&quot;</span>);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     <span class="comment">// Check chip types</span>
<a name="l00311"></a>00311     vector&lt;string&gt; chipTypesInLayout;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <span class="comment">/* Get the intial info about the chip and check cel files to make sure they match. */</span>
<a name="l00314"></a>00314     <a class="code" href="AptTypes_8h.html#a6b6d41ded05bd1136b17fa18be0d744f" title="For row and column indexes.">colrow_t</a> numRows = 0, numCols = 0;
<a name="l00315"></a>00315     <span class="keywordtype">int</span> probeCount = 0, probeSetCount = 0, channelCount = 1;
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     <span class="keywordtype">string</span> cdfFile = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cdf-file&quot;</span>);
<a name="l00318"></a>00318     <span class="keywordtype">string</span> spfFile = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;spf-file&quot;</span>);
<a name="l00319"></a>00319     <span class="keywordflow">if</span> (cdfFile!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00320"></a>00320         <a class="code" href="classEngineUtil.html#ade4ca714ab18a0ec35750acb9223cb4f" title="Open up a cdf file and get the chip type (i.e.">EngineUtil::getCdfChipType</a>(chipTypesInLayout, numRows, numCols, 
<a name="l00321"></a>00321                                    probeCount, probeSetCount, cdfFile);
<a name="l00322"></a>00322     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (spfFile!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00323"></a>00323         <a class="code" href="classEngineUtil.html#a983c94e51a248918b98899f262f3e11a" title="Open up a spf (simple probe format) file and read the valid chiptypes (i.e.">EngineUtil::getSpfChipType</a>(chipTypesInLayout, numRows, numCols, 
<a name="l00324"></a>00324                                    probeCount, probeSetCount, spfFile);
<a name="l00325"></a>00325     <span class="keywordflow">else</span>
<a name="l00326"></a>00326         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Must specify a cdf file, spf file, or PGF and CLF files.&quot;</span>);
<a name="l00327"></a>00327 
<a name="l00328"></a>00328     <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;num-rows&quot;</span>, <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(numRows));
<a name="l00329"></a>00329     <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;num-cols&quot;</span>, <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(numCols));
<a name="l00330"></a>00330     <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;probe-count&quot;</span>, <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(probeCount));
<a name="l00331"></a>00331     <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;channel-count&quot;</span>, <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(channelCount));
<a name="l00332"></a>00332 
<a name="l00333"></a>00333     <span class="keywordflow">if</span> (chipTypesInLayout.empty() || chipTypesInLayout[0] == <span class="stringliteral">&quot;&quot;</span> || 
<a name="l00334"></a>00334         probeCount == 0) 
<a name="l00335"></a>00335         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Problem determining ChipType in file: &quot;</span> + 
<a name="l00336"></a>00336                       ( cdfFile != <span class="stringliteral">&quot;&quot;</span> ? cdfFile : spfFile));
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     <span class="comment">/* Did the user &quot;force&quot; a set of chip types via options? */</span>
<a name="l00339"></a>00339     vector&lt;string&gt; chipTypesSupplied = <a class="code" href="classOptions.html#ab20d0083424d9d9a8b94da46f487f57a" title="Return a vector of values for a particular option.">getOptVector</a>(<span class="stringliteral">&quot;chip-type&quot;</span>);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341     <span class="comment">/* Figure out what chip type to report */</span>
<a name="l00342"></a>00342     <span class="keywordflow">if</span> (chipTypesSupplied.size() &gt; 0) {
<a name="l00343"></a>00343         <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;chip-type&quot;</span>, chipTypesSupplied[0]);
<a name="l00344"></a>00344     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chipTypesInLayout.size() &gt; 0) {
<a name="l00345"></a>00345         <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;chip-type&quot;</span>, chipTypesInLayout[0]);
<a name="l00346"></a>00346     } <span class="keywordflow">else</span> {
<a name="l00347"></a>00347         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Unable to figure out a chip type.&quot;</span>);
<a name="l00348"></a>00348     }
<a name="l00349"></a>00349 
<a name="l00350"></a>00350     vector&lt;string&gt; chipTypesToCheck;
<a name="l00351"></a>00351     <span class="keywordflow">if</span> (chipTypesSupplied.size() &gt; 0) {
<a name="l00352"></a>00352         chipTypesToCheck = chipTypesSupplied;
<a name="l00353"></a>00353     } <span class="keywordflow">else</span> {
<a name="l00354"></a>00354         chipTypesToCheck = chipTypesInLayout;
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356 
<a name="l00357"></a>00357     <span class="comment">/* Do Chip Type Check */</span>
<a name="l00358"></a>00358     <span class="keywordflow">if</span> (!<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;force&quot;</span>)) {
<a name="l00359"></a>00359         <span class="keywordflow">if</span> (chipTypesSupplied.size() &gt; 0) {
<a name="l00360"></a>00360             <a class="code" href="classEngineUtil.html#a6b5c169d7d42f87da86f31f675df557a" title="Check to make sure that there is at least one match between the two vectors of chip types...">EngineUtil::checkChipTypeVectors</a>(chipTypesSupplied, chipTypesInLayout);
<a name="l00361"></a>00361         }
<a name="l00362"></a>00362         <a class="code" href="classEngineUtil.html#a952a57d44838690761d2f0bd28cd7a16" title="Check to make sure all the cel files are compatible with the chiptypes supported and number or probes...">EngineUtil::checkCelChipTypes</a>(chipTypesToCheck, probeCount, celFiles, numRows, numCols);
<a name="l00363"></a>00363     }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <span class="comment">// check the map files and get the map name and version</span>
<a name="l00366"></a>00366     vector&lt;string&gt; files;
<a name="l00367"></a>00367     files.push_back(<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cnv-region-file&quot;</span>));
<a name="l00368"></a>00368     files.push_back(<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cnv-map-file&quot;</span>));
<a name="l00369"></a>00369     files.push_back(<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cnv-normalization-file&quot;</span>));
<a name="l00370"></a>00370     files.push_back(<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cnv-prior-file&quot;</span>));
<a name="l00371"></a>00371     <span class="keywordtype">string</span> mapName, mapVersion;
<a name="l00372"></a>00372     check_input_file_headers(chipTypesToCheck, files, mapName, mapVersion, 
<a name="l00373"></a>00373                              <a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;force&quot;</span>));
<a name="l00374"></a>00374     <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;map-name&quot;</span>, mapName);
<a name="l00375"></a>00375     <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;map-version&quot;</span>,mapVersion);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     <span class="comment">// default analysis name is pulled from the regions file</span>
<a name="l00378"></a>00378     <span class="keywordflow">if</span> (<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;analysis-name&quot;</span>) == <span class="stringliteral">&quot;&quot;</span>)
<a name="l00379"></a>00379         <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;analysis-name&quot;</span>, mapName + <span class="stringliteral">&quot;-&quot;</span> + mapVersion);
<a name="l00380"></a>00380     <span class="keywordflow">else</span>
<a name="l00381"></a>00381         <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;analysis-name&quot;</span>,<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;analysis-name&quot;</span>));
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="keywordflow">if</span> (<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;exec-guid&quot;</span>) == <span class="stringliteral">&quot;&quot;</span>)
<a name="l00384"></a>00384         <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;exec-guid&quot;</span>, <a class="code" href="classaffxutil_1_1Guid.html#a2929c982cb9f3b5f6c5d7d818a8e6ac4">affxutil::Guid::GenerateNewGuid</a>());
<a name="l00385"></a>00385     <span class="keywordflow">else</span>
<a name="l00386"></a>00386         <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;exec-guid&quot;</span>, <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;exec-guid&quot;</span>));
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     <span class="comment">// Always set this -- as we own it</span>
<a name="l00389"></a>00389     <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;analysis-guid&quot;</span>, <a class="code" href="classaffxutil_1_1Guid.html#a2929c982cb9f3b5f6c5d7d818a8e6ac4">affxutil::Guid::GenerateNewGuid</a>()) ;
<a name="l00390"></a>00390     <a class="code" href="classOptions.html#aaf215b45e7097fcedae68c15073eb0f8" title="Set option value.">setOpt</a>(<span class="stringliteral">&quot;genome-version&quot;</span>, get_genome_version(<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cnv-region-file&quot;</span>)));
<a name="l00391"></a>00391 
<a name="l00392"></a>00392     <span class="keywordflow">if</span> (!Fs::isWriteableDir(<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;out-dir&quot;</span>)))          
<a name="l00393"></a>00393         <span class="keywordflow">if</span> (<a class="code" href="classFs.html#aea474e8df7665f070c5334fa322bd283" title="make all path of directories ///">Fs::mkdirPath</a>(<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;out-dir&quot;</span>), <span class="keyword">false</span>) != APT_OK)   
<a name="l00394"></a>00394             <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Can&#39;t make or write to directory: &quot;</span> + 
<a name="l00395"></a>00395                           <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;out-dir&quot;</span>));    
<a name="l00396"></a>00396     makeTempDir(<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;temp-dir&quot;</span>));
<a name="l00397"></a>00397 }
<a name="l00398"></a>00398 <span class="comment"></span>
<a name="l00399"></a>00399 <span class="comment">/**</span>
<a name="l00400"></a>00400 <span class="comment"> * @brief checks if there is enough disk space for diskmarts in the</span>
<a name="l00401"></a>00401 <span class="comment"> * temp-dir and for chp files in out-dir</span>
<a name="l00402"></a>00402 <span class="comment"> */</span>
<a name="l00403"></a>00403 <span class="keywordtype">void</span> CanaryEngine::checkDiskSpaceImp() {
<a name="l00404"></a>00404     int64_t out_disk_available = -1, scratch_disk_available = -1;
<a name="l00405"></a>00405   
<a name="l00406"></a>00406     <span class="keywordtype">int</span> cel_count = <a class="code" href="classOptions.html#ab20d0083424d9d9a8b94da46f487f57a" title="Return a vector of values for a particular option.">getOptVector</a>(<span class="stringliteral">&quot;cels&quot;</span>).size();
<a name="l00407"></a>00407     <span class="keywordtype">int</span> row_count = <a class="code" href="classOptions.html#afcfab86e21cac5bba43e0858bd428e62" title="Get the integer value of an option.">getOptInt</a>(<span class="stringliteral">&quot;num-rows&quot;</span>);
<a name="l00408"></a>00408     <span class="keywordtype">int</span> col_count = <a class="code" href="classOptions.html#afcfab86e21cac5bba43e0858bd428e62" title="Get the integer value of an option.">getOptInt</a>(<span class="stringliteral">&quot;num-cols&quot;</span>);
<a name="l00409"></a>00409     <span class="keywordtype">int</span> channel_count = <a class="code" href="classOptions.html#afcfab86e21cac5bba43e0858bd428e62" title="Get the integer value of an option.">getOptInt</a>(<span class="stringliteral">&quot;channel-count&quot;</span>);
<a name="l00410"></a>00410     <span class="comment">// @todo get analysis_stream_count, if necessary</span>
<a name="l00411"></a>00411     <span class="comment">// int analysis_stream_count = getOptInt(&quot;analysis-count&quot;);</span>
<a name="l00412"></a>00412     <span class="keywordtype">int</span> analysis_stream_count = 1;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414     std::vector&lt;std::string&gt; result_files = <a class="code" href="classOptions.html#ab20d0083424d9d9a8b94da46f487f57a" title="Return a vector of values for a particular option.">getOptVector</a>(<span class="stringliteral">&quot;result-files&quot;</span>);
<a name="l00415"></a>00415     std::string out_dir;
<a name="l00416"></a>00416     <span class="keywordflow">if</span> (!result_files.empty()) {
<a name="l00417"></a>00417       out_dir = <a class="code" href="classFs.html#a5308b59c6136f59d7f28947fcc0c6a71" title="just the dirname (will return &amp;quot;.&amp;quot; or &amp;quot;/&amp;quot; as well.) ///">Fs::dirname</a>(result_files[0]);<span class="comment"></span>
<a name="l00418"></a>00418 <span class="comment">      ///@todo iterate through all of the result dirs to check available</span>
<a name="l00419"></a>00419 <span class="comment"></span>      <span class="comment">// disk space</span>
<a name="l00420"></a>00420     }
<a name="l00421"></a>00421     <span class="comment"></span>
<a name="l00422"></a>00422 <span class="comment">    ///@todo get name of parameter that specifies chp-out-dir, if any</span>
<a name="l00423"></a>00423 <span class="comment"></span><span class="comment">//   if (out_dir.empty()) {</span>
<a name="l00424"></a>00424 <span class="comment">//     out_dir = getOpt(&quot;cc-chp-out-dir&quot;);</span>
<a name="l00425"></a>00425 <span class="comment">//   }</span>
<a name="l00426"></a>00426    
<a name="l00427"></a>00427     <span class="keywordflow">if</span> (out_dir.empty()) {
<a name="l00428"></a>00428         out_dir = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;out-dir&quot;</span>);
<a name="l00429"></a>00429     }
<a name="l00430"></a>00430         
<a name="l00431"></a>00431     out_disk_available = <a class="code" href="classFs.html#a831258fc40b99039b9703a438626f78d" title="///">Fs::getFreeDiskSpace</a>(out_dir, <span class="keyword">false</span>);
<a name="l00432"></a>00432         
<a name="l00433"></a>00433     uint64_t out_disk_needed = 0;
<a name="l00434"></a>00434     std::string region_file = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;cnv-region-file&quot;</span>);
<a name="l00435"></a>00435     <span class="keywordflow">if</span> (!region_file.empty()) {
<a name="l00436"></a>00436         <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">TsvFile</a> tsv;
<a name="l00437"></a>00437         <span class="keywordflow">if</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#a763ce0bbf19b4134d0445aa58e0f5011" title="Opens a file -- attempts to guess some defaults.">open</a>(region_file) != TSV_OK) {
<a name="l00438"></a>00438             <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Couldn&#39;t open file: &#39;&quot;</span> + region_file + <span class="stringliteral">&quot;&#39; to read.&quot;</span>);
<a name="l00439"></a>00439         }
<a name="l00440"></a>00440         <span class="keywordtype">int</span> num_regions = tsv.countTotalDataLines();
<a name="l00441"></a>00441         out_disk_needed = <span class="keyword">static_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(num_regions) * cel_count * 38.39;
<a name="l00442"></a>00442     }
<a name="l00443"></a>00443         
<a name="l00444"></a>00444     <span class="comment">// (1 + analysis_stream_count): one initial raw diskmart + one</span>
<a name="l00445"></a>00445     <span class="comment">// diskmarts for each analysis stream</span>
<a name="l00446"></a>00446     uint64_t scratch_disk_needed = 0;
<a name="l00447"></a>00447     <span class="keywordflow">if</span> (<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;use-disk&quot;</span>)) {
<a name="l00448"></a>00448         scratch_disk_needed = <span class="keyword">static_cast&lt;</span>uint64_t<span class="keyword">&gt;</span>(row_count) * col_count * cel_count * channel_count * 4.04 * (1 + analysis_stream_count);
<a name="l00449"></a>00449     }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     std::string temp_dir = <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;temp-dir&quot;</span>);
<a name="l00452"></a>00452     AptErr_t aptErr = APT_OK;
<a name="l00453"></a>00453     <span class="keywordtype">bool</span> same_disk = <a class="code" href="classFs.html#a366e4688dc65aa638b7af8cebd744d49" title="Do these two paths refer to the same volume? /.">Fs::isSameVolume</a>(temp_dir, out_dir, aptErr, <span class="keyword">false</span>);
<a name="l00454"></a>00454     <span class="keywordflow">if</span> (temp_dir.empty() ||
<a name="l00455"></a>00455         same_disk || 
<a name="l00456"></a>00456         ((aptErr != APT_OK) &amp;&amp; (temp_dir == out_dir))
<a name="l00457"></a>00457         ) {
<a name="l00458"></a>00458         out_disk_needed += scratch_disk_needed;
<a name="l00459"></a>00459     }
<a name="l00460"></a>00460     <span class="keywordflow">else</span> {
<a name="l00461"></a>00461         scratch_disk_available = <a class="code" href="classFs.html#a831258fc40b99039b9703a438626f78d" title="///">Fs::getFreeDiskSpace</a>(temp_dir, <span class="keyword">false</span>);
<a name="l00462"></a>00462         <span class="keywordflow">if</span> (scratch_disk_needed &gt; 0 &amp;&amp; 
<a name="l00463"></a>00463             scratch_disk_available &gt;= 0 &amp;&amp;
<a name="l00464"></a>00464             scratch_disk_needed &gt;= scratch_disk_available) {
<a name="l00465"></a>00465             <span class="comment">// format in kb</span>
<a name="l00466"></a>00466             scratch_disk_needed = (scratch_disk_needed + 512) / 1024;
<a name="l00467"></a>00467             scratch_disk_available = (scratch_disk_available + 512) / 1024;
<a name="l00468"></a>00468             <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;In &quot;</span> + temp_dir + <span class="stringliteral">&quot;, need &quot;</span> + 
<a name="l00469"></a>00469                           <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(scratch_disk_needed) + 
<a name="l00470"></a>00470                           <span class="stringliteral">&quot;kb of scratch diskspace.  Only &quot;</span> + 
<a name="l00471"></a>00471                           <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(scratch_disk_available) + <span class="stringliteral">&quot;kb available.&quot;</span>);
<a name="l00472"></a>00472         }
<a name="l00473"></a>00473     }
<a name="l00474"></a>00474         
<a name="l00475"></a>00475     <span class="keywordflow">if</span> (out_disk_needed &gt; 0 &amp;&amp;
<a name="l00476"></a>00476         out_disk_available &gt;= 0 &amp;&amp;
<a name="l00477"></a>00477         out_disk_needed &gt;= out_disk_available) {
<a name="l00478"></a>00478         <span class="comment">// format in kb</span>
<a name="l00479"></a>00479         out_disk_needed = (out_disk_needed + 512) / 1024;
<a name="l00480"></a>00480         out_disk_available = (out_disk_available + 512) / 1024;
<a name="l00481"></a>00481         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;In &quot;</span> + out_dir + <span class="stringliteral">&quot;, need &quot;</span> + <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(out_disk_needed) + 
<a name="l00482"></a>00482                       <span class="stringliteral">&quot;kb of diskspace.  Only &quot;</span> + <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(out_disk_available) + 
<a name="l00483"></a>00483                       <span class="stringliteral">&quot;kb available.&quot;</span>);
<a name="l00484"></a>00484     }
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487 <span class="keywordtype">void</span> CanaryEngine::runImp() {
<a name="l00488"></a>00488     <a class="code" href="classCanaryOptions.html" title="Place to group program options.">CanaryOptions</a> myOpts;
<a name="l00489"></a>00489     fillInOptions(myOpts);
<a name="l00490"></a>00490     myOpts.setTuneableStr();
<a name="l00491"></a>00491     CanaryCompute(myOpts);
<a name="l00492"></a>00492     removeTempDir(<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;temp-dir&quot;</span>));
<a name="l00493"></a>00493 }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495 <span class="comment">/*</span>
<a name="l00496"></a>00496 <span class="comment"> * Read the design of the chip from the cdf or spf file.</span>
<a name="l00497"></a>00497 <span class="comment"> *</span>
<a name="l00498"></a>00498 <span class="comment"> * @param layout       - Object to be filled in.</span>
<a name="l00499"></a>00499 <span class="comment"> * @param opts         - Supplied engine options</span>
<a name="l00500"></a>00500 <span class="comment"> * @param libpsets     - Set of probeset names to be filled in</span>
<a name="l00501"></a>00501 <span class="comment"> */</span>
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 <span class="keywordtype">void</span> CanaryEngine::loadCdfLayout_canary(<a class="code" href="classChipLayout.html" title="ChipLayout - Data structure to represent the probesets encoded in the CDF, SPF or PGF files which def...">ChipLayout</a> &amp; layout, 
<a name="l00504"></a>00504                                         <a class="code" href="classCanaryOptions.html" title="Place to group program options.">CanaryOptions</a> &amp; opts,
<a name="l00505"></a>00505                                         set&lt;string&gt; &amp; libpsets) {
<a name="l00506"></a>00506     set&lt;affxcdf::GeneChipProbeSetType&gt; psTypesToLoad;
<a name="l00507"></a>00507     set&lt;const char *, Util::ltstr&gt; probeSetsToLoad;
<a name="l00508"></a>00508     vector&lt;const char *&gt; probesetNames;
<a name="l00509"></a>00509     vector&lt;bool&gt; probeSubset;
<a name="l00510"></a>00510 
<a name="l00511"></a>00511     <span class="keywordflow">if</span> (opts.cdfFile != <span class="stringliteral">&quot;&quot;</span>) {
<a name="l00512"></a>00512         <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(1,<span class="stringliteral">&quot;Loading chip layout information from CDF file.&quot;</span>);
<a name="l00513"></a>00513         probeidmap_t dummy_killList;
<a name="l00514"></a>00514         <span class="keywordflow">if</span> (!layout.<a class="code" href="classChipLayout.html#aa9bdb0e181302d4953aab10ed847c7bf" title="Open a file and parse the probe sets.">openCdf</a>(opts.cdfFile, probeSetsToLoad,
<a name="l00515"></a>00515                             &amp;probesetNames, probeSubset, <span class="stringliteral">&quot;&quot;</span>, dummy_killList, 
<a name="l00516"></a>00516                             <span class="keyword">false</span>,
<a name="l00517"></a>00517                             psTypesToLoad))
<a name="l00518"></a>00518             <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Unable to open CDF file.&quot;</span>);
<a name="l00519"></a>00519     }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (opts.spfFile != <span class="stringliteral">&quot;&quot;</span>) {
<a name="l00522"></a>00522         <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(1,<span class="stringliteral">&quot;Loading chip layout information from SPF file.&quot;</span>);
<a name="l00523"></a>00523         layout.<a class="code" href="classChipLayout.html#af902ac26fbddd00db96825c4b9830379" title="Read in probelist data from a simple probe format file.">openSpf</a>(opts.spfFile, probeSetsToLoad, &amp;probesetNames,
<a name="l00524"></a>00524                        probeSubset, <span class="stringliteral">&quot;&quot;</span>, <span class="keyword">false</span>, psTypesToLoad);
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <span class="keywordflow">else</span> <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Must have either a cdf file or spf file.&quot;</span>);
<a name="l00528"></a>00528 
<a name="l00529"></a>00529     libpsets.clear();
<a name="l00530"></a>00530     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k=0; k&lt;probesetNames.size(); k++) {
<a name="l00531"></a>00531         libpsets.insert(probesetNames[k]);
<a name="l00532"></a>00532         <span class="keyword">delete</span>[] probesetNames[k];
<a name="l00533"></a>00533         probesetNames[k] = NULL;
<a name="l00534"></a>00534     }
<a name="l00535"></a>00535 }
<a name="l00536"></a>00536 
<a name="l00537"></a>00537 
<a name="l00538"></a>00538 <span class="comment">/*</span>
<a name="l00539"></a>00539 <span class="comment"> * Return the list of cnv probes to run through pre-canary</span>
<a name="l00540"></a>00540 <span class="comment"> */</span>
<a name="l00541"></a>00541 
<a name="l00542"></a>00542 set&lt;string&gt; CanaryEngine::get_cnv_psets(map&lt;<span class="keywordtype">string</span>,vector&lt;string&gt; &gt; &amp;cnv_region_map) {
<a name="l00543"></a>00543     set&lt;string&gt;probe_names;
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     <span class="comment">// walk the map and load up probe_names</span>
<a name="l00546"></a>00546     map&lt;string,vector&lt;string&gt; &gt;::iterator iter;
<a name="l00547"></a>00547     <span class="keywordflow">for</span> (iter=cnv_region_map.begin(); iter != cnv_region_map.end(); iter++) {
<a name="l00548"></a>00548         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;iter-&gt;second.size(); i++)
<a name="l00549"></a>00549             probe_names.insert(iter-&gt;second[i]);
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552     <span class="keywordflow">return</span> probe_names;
<a name="l00553"></a>00553 }
<a name="l00554"></a>00554 
<a name="l00555"></a>00555 
<a name="l00556"></a>00556 <span class="comment">/*</span>
<a name="l00557"></a>00557 <span class="comment"> * Return the list of normalization to use</span>
<a name="l00558"></a>00558 <span class="comment"> */</span>
<a name="l00559"></a>00559 
<a name="l00560"></a>00560 set&lt;string&gt; CanaryEngine::get_normalization_psets(<span class="keywordtype">string</span> ifname) {
<a name="l00561"></a>00561     set&lt;string&gt;probe_names;
<a name="l00562"></a>00562   
<a name="l00563"></a>00563     <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">TsvFile</a> cn_normfile;
<a name="l00564"></a>00564     <span class="keywordtype">string</span> the_probe;
<a name="l00565"></a>00565     cn_normfile.bind(0,<span class="stringliteral">&quot;probeset_id&quot;</span>,&amp;the_probe,<a class="code" href="namespaceaffx.html#a8f36853f1d3b6cfb79edebd82760691daf605fbe0e244c4a604d176991d8df2c6" title="warn if not bound">TSV_BIND_REQUIRED</a>);
<a name="l00566"></a>00566     <span class="keywordflow">if</span> (cn_normfile.<a class="code" href="classaffx_1_1TsvFile.html#a763ce0bbf19b4134d0445aa58e0f5011" title="Opens a file -- attempts to guess some defaults.">open</a>(ifname) != TSV_OK)
<a name="l00567"></a>00567         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Couldn&#39;t open file: &quot;</span> + ifname + <span class="stringliteral">&quot; to read.&quot;</span>);
<a name="l00568"></a>00568 
<a name="l00569"></a>00569     <span class="keywordflow">while</span> (cn_normfile.<a class="code" href="classaffx_1_1TsvFile.html#a2022895d082d1d635e7f59fccab12afb" title="Skip to the next level of data which matches seek_clvl ///.">nextLevel</a>(0)==TSV_OK) {
<a name="l00570"></a>00570         cn_normfile.<a class="code" href="classaffx_1_1TsvFile.html#a7a81092ce134e8c9116a1a5bcfe287d1" title="Get the string value of a field ///.">get</a>(cn_normfile.<a class="code" href="classaffx_1_1TsvFile.html#a0bc68ccdf8993fd46b812c7743f8ab1d" title="The indentation level of the line just read. ///.">lineLevel</a>(),0,the_probe);
<a name="l00571"></a>00571         probe_names.insert(the_probe);
<a name="l00572"></a>00572     }
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     <span class="keywordflow">return</span> probe_names;
<a name="l00575"></a>00575 }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577 <span class="comment">/*</span>
<a name="l00578"></a>00578 <span class="comment"> * Returns a boolean vector of probes to be analysed according to</span>
<a name="l00579"></a>00579 <span class="comment"> * the set of probe set names</span>
<a name="l00580"></a>00580 <span class="comment"> */</span>
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 vector&lt;string&gt; CanaryEngine::get_available_psets(set&lt;string&gt; &amp; cnv_probes,
<a name="l00583"></a>00583                                                  set&lt;string&gt; &amp; normalization_probes, 
<a name="l00584"></a>00584                                                  set&lt;string&gt; &amp; all_probes,
<a name="l00585"></a>00585                                                  <a class="code" href="classCanaryOptions.html" title="Place to group program options.">CanaryOptions</a> &amp; opts) {
<a name="l00586"></a>00586     set&lt;string&gt;psets;
<a name="l00587"></a>00587     set&lt;string&gt;not_found;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589     <span class="keywordflow">for</span> (set&lt;string&gt;::iterator iter=cnv_probes.begin();
<a name="l00590"></a>00590          iter!=cnv_probes.end(); iter++) {
<a name="l00591"></a>00591         <span class="keywordflow">if</span> (all_probes.find(*iter) != all_probes.end()) psets.insert(*iter);
<a name="l00592"></a>00592         <span class="keywordflow">else</span> not_found.insert(*iter);
<a name="l00593"></a>00593     }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595     <span class="keywordflow">for</span> (set&lt;string&gt;::iterator iter=normalization_probes.begin();
<a name="l00596"></a>00596          iter!=normalization_probes.end(); iter++) {
<a name="l00597"></a>00597         <span class="keywordflow">if</span> (all_probes.find(*iter) != all_probes.end()) psets.insert(*iter);
<a name="l00598"></a>00598         <span class="keywordflow">else</span> not_found.insert(*iter);
<a name="l00599"></a>00599     }
<a name="l00600"></a>00600 
<a name="l00601"></a>00601     vector&lt;string&gt;pset_vec;
<a name="l00602"></a>00602     <span class="keywordflow">for</span> (set&lt;string&gt;::iterator iter=psets.begin(); iter!=psets.end(); iter++) {
<a name="l00603"></a>00603         pset_vec.push_back(*iter);
<a name="l00604"></a>00604     }
<a name="l00605"></a>00605 
<a name="l00606"></a>00606     <span class="comment">/*</span>
<a name="l00607"></a>00607 <span class="comment">      Used to be able to put missing probes in a file.  To conform with</span>
<a name="l00608"></a>00608 <span class="comment">      GTC just write them to verbose output.</span>
<a name="l00609"></a>00609 <span class="comment">    */</span>
<a name="l00610"></a>00610     <span class="keywordflow">for</span> (set&lt;string&gt;::iterator iter=not_found.begin();
<a name="l00611"></a>00611          iter!=not_found.end(); iter++) {
<a name="l00612"></a>00612         <span class="keywordtype">string</span> vstr = *iter + <span class="stringliteral">&quot;: probe not found in chip definition&quot;</span>;
<a name="l00613"></a>00613         <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(2,vstr.c_str());
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615 
<a name="l00616"></a>00616     <span class="keywordflow">return</span> pset_vec;
<a name="l00617"></a>00617 }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619 
<a name="l00620"></a>00620 <span class="keywordtype">void</span> CanaryEngine::averageAlleles(<a class="code" href="classCanaryOptions.html" title="Place to group program options.">CanaryOptions</a> &amp;opts) {
<a name="l00621"></a>00621     <span class="comment">// Input and output file names</span><span class="comment"></span>
<a name="l00622"></a>00622 <span class="comment">    ///@todo Next time maybe not hard code file name extensions in </span>
<a name="l00623"></a>00623 <span class="comment"></span>    <span class="comment">// multiple places.</span>
<a name="l00624"></a>00624     <span class="keywordtype">string</span> ifname = <a class="code" href="classFs.html#af44351abee4cbc47f94b83cb2f62899f" title="join strings with the path sep. /// while we would want people to keep the path with FsPath...">Fs::join</a>(opts.outDir, opts.setAnalysisName + <span class="stringliteral">&quot;.summary.txt&quot;</span>);
<a name="l00625"></a>00625     <span class="keywordtype">string</span> ofname = <a class="code" href="classFs.html#af44351abee4cbc47f94b83cb2f62899f" title="join strings with the path sep. /// while we would want people to keep the path with FsPath...">Fs::join</a>(opts.outDir, opts.setAnalysisName + <span class="stringliteral">&quot;.allele_average_summary.txt&quot;</span>);
<a name="l00626"></a>00626 
<a name="l00627"></a>00627     <span class="comment">// Open the input file and get the number of columns</span>
<a name="l00628"></a>00628     <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">TsvFile</a> infile;
<a name="l00629"></a>00629     <span class="keywordflow">if</span> (infile.<a class="code" href="classaffx_1_1TsvFile.html#a763ce0bbf19b4134d0445aa58e0f5011" title="Opens a file -- attempts to guess some defaults.">open</a>(ifname) != TSV_OK)
<a name="l00630"></a>00630         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Unable to open allele signal input file &#39;&quot;</span> + ifname + <span class="stringliteral">&quot;&#39;&quot;</span>);
<a name="l00631"></a>00631     <span class="keywordtype">int</span> ncol = infile.<a class="code" href="classaffx_1_1TsvFile.html#a94ad901d12ab05cce0f050f99665970f" title="The number of columns for this level ///.">getColumnCount</a>(0);
<a name="l00632"></a>00632 
<a name="l00633"></a>00633     <span class="comment">// Declare the output TsvFile</span>
<a name="l00634"></a>00634     <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">TsvFile</a> outfile;
<a name="l00635"></a>00635 <span class="comment">//      outfile.setPrecision(opts.precision);  // kicks out an error on compile</span>
<a name="l00636"></a>00636 
<a name="l00637"></a>00637     <span class="comment">// Define the column names from the old file</span>
<a name="l00638"></a>00638     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ncol; i++) {
<a name="l00639"></a>00639         <span class="keywordtype">string</span> cname = infile.getColumnName(0,i);
<a name="l00640"></a>00640         outfile.<a class="code" href="classaffx_1_1TsvFile.html#aadc22863a63b9c6588b0f2dc61875809" title="User methods.">defineColumn</a>(0,i,cname);
<a name="l00641"></a>00641     }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643     outfile.<a class="code" href="classaffx_1_1TsvFile.html#a1903489904b4e2f8f2a262b8f10cdb0e" title="Set the options up for &amp;quot;tsv&amp;quot; format and write the tsv-v1 header ///.">writeTsv_v1</a>(ofname);
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     <span class="keywordflow">while</span> (infile.<a class="code" href="classaffx_1_1TsvFile.html#a2022895d082d1d635e7f59fccab12afb" title="Skip to the next level of data which matches seek_clvl ///.">nextLevel</a>(0)==TSV_OK) {
<a name="l00646"></a>00646         <span class="keywordtype">string</span> probe_name;
<a name="l00647"></a>00647         <span class="keywordtype">double</span> value;
<a name="l00648"></a>00648         infile.<a class="code" href="classaffx_1_1TsvFile.html#a7a81092ce134e8c9116a1a5bcfe287d1" title="Get the string value of a field ///.">get</a>(0,0,probe_name);
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         <span class="comment">// Just write out the values again</span>
<a name="l00651"></a>00651         <span class="keywordflow">if</span> (probe_name[0] == <span class="charliteral">&#39;C&#39;</span>) {
<a name="l00652"></a>00652             outfile.set(0,0,probe_name);
<a name="l00653"></a>00653             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i&lt;ncol; i++) {
<a name="l00654"></a>00654                 infile.<a class="code" href="classaffx_1_1TsvFile.html#a7a81092ce134e8c9116a1a5bcfe287d1" title="Get the string value of a field ///.">get</a>(0,i,value);
<a name="l00655"></a>00655                 outfile.set(0,i,value);
<a name="l00656"></a>00656             }
<a name="l00657"></a>00657         }
<a name="l00658"></a>00658 
<a name="l00659"></a>00659         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (probe_name[0] == <span class="charliteral">&#39;S&#39;</span>) {
<a name="l00660"></a>00660             probe_name.erase(probe_name.size()-2);
<a name="l00661"></a>00661             outfile.set(0,0,probe_name);
<a name="l00662"></a>00662             valarray&lt;double&gt; valuesA(ncol-1);
<a name="l00663"></a>00663             valarray&lt;double&gt; valuesB(ncol-1);
<a name="l00664"></a>00664             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ncol-1; i++) infile.<a class="code" href="classaffx_1_1TsvFile.html#a7a81092ce134e8c9116a1a5bcfe287d1" title="Get the string value of a field ///.">get</a>(0,i+1,valuesA[i]);
<a name="l00665"></a>00665             infile.<a class="code" href="classaffx_1_1TsvFile.html#a2022895d082d1d635e7f59fccab12afb" title="Skip to the next level of data which matches seek_clvl ///.">nextLevel</a>(0);
<a name="l00666"></a>00666             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ncol-1; i++) infile.<a class="code" href="classaffx_1_1TsvFile.html#a7a81092ce134e8c9116a1a5bcfe287d1" title="Get the string value of a field ///.">get</a>(0,i+1,valuesB[i]);
<a name="l00667"></a>00667 
<a name="l00668"></a>00668             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;ncol-1; i++) {
<a name="l00669"></a>00669                 <span class="keywordtype">double</span> ABavg = 0.5*(valuesA[i] + valuesB[i]);
<a name="l00670"></a>00670                 outfile.set(0,i+1,ABavg);
<a name="l00671"></a>00671             }
<a name="l00672"></a>00672         }
<a name="l00673"></a>00673 
<a name="l00674"></a>00674         <span class="keywordflow">else</span>
<a name="l00675"></a>00675         {
<a name="l00676"></a>00676             <span class="keywordtype">string</span> vstr = probe_name +
<a name="l00677"></a>00677                 <span class="stringliteral">&quot; not recognized as copy number or SNP when averaging alleles&quot;</span>;
<a name="l00678"></a>00678             <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(2,vstr);
<a name="l00679"></a>00679         }
<a name="l00680"></a>00680         outfile.<a class="code" href="classaffx_1_1TsvFile.html#a2a459be42bea9ea3f180773370ec0de7" title="Write a level of data to the file. ///.">writeLevel</a>(0);
<a name="l00681"></a>00681     }
<a name="l00682"></a>00682 
<a name="l00683"></a>00683     infile.<a class="code" href="classaffx_1_1TsvFile.html#ae7932be2156c04a562f327b53833aed7" title="Close the file.">close</a>();
<a name="l00684"></a>00684     outfile.<a class="code" href="classaffx_1_1TsvFile.html#ae7932be2156c04a562f327b53833aed7" title="Close the file.">close</a>();
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="comment">// get rid of the apt-probeset-summarize input</span>
<a name="l00687"></a>00687     <span class="keywordflow">if</span> (!opts.tableOutput)
<a name="l00688"></a>00688         <a class="code" href="classFs.html#a6b8f232817f933a42c21edde6ea55a3a" title="An error if it doesnt exist.">Fs::rm</a>(ifname, <span class="keyword">false</span>);
<a name="l00689"></a>00689 }
<a name="l00690"></a>00690 
<a name="l00691"></a>00691 <span class="keywordtype">void</span> CanaryEngine::get_meta_tags(<span class="keywordtype">string</span> file, vector&lt;string&gt; &amp;keys, 
<a name="l00692"></a>00692                                  vector&lt;string&gt; &amp;vals) {
<a name="l00693"></a>00693     <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">TsvFile</a> tsv;
<a name="l00694"></a>00694     <span class="keywordtype">string</span> key, val;
<a name="l00695"></a>00695     <span class="keywordflow">if</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#a763ce0bbf19b4134d0445aa58e0f5011" title="Opens a file -- attempts to guess some defaults.">open</a>(file) != TSV_OK)
<a name="l00696"></a>00696         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Couldn&#39;t open file: &#39;&quot;</span> + file + <span class="stringliteral">&quot;&#39; to read.&quot;</span>);
<a name="l00697"></a>00697     tsv.<a class="code" href="classaffx_1_1TsvFile.html#a6aad66cac289e3eeed0bc06ba0e2587b" title="Start at the beginning of the headers ///.">headersBegin</a>();
<a name="l00698"></a>00698     <span class="keywordflow">while</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#a86c80445dd06ed593e194f85e8ad8946" title="Advance to the next header of the file and set the values ///.">headersNext</a>(key,val)==affx::TSV_OK) {
<a name="l00699"></a>00699         keys.push_back(key);
<a name="l00700"></a>00700         vals.push_back(val);
<a name="l00701"></a>00701     }
<a name="l00702"></a>00702     tsv.<a class="code" href="classaffx_1_1TsvFile.html#ae7932be2156c04a562f327b53833aed7" title="Close the file.">close</a>();
<a name="l00703"></a>00703 }
<a name="l00704"></a>00704 
<a name="l00705"></a>00705 <span class="keywordtype">string</span> CanaryEngine::get_genome_version(<span class="keywordtype">string</span> cnvRegionFile) {
<a name="l00706"></a>00706     <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">TsvFile</a> tsv;
<a name="l00707"></a>00707     <span class="keywordtype">string</span> genomeVersion;
<a name="l00708"></a>00708     <span class="keywordflow">if</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#a763ce0bbf19b4134d0445aa58e0f5011" title="Opens a file -- attempts to guess some defaults.">open</a>(cnvRegionFile) != TSV_OK)
<a name="l00709"></a>00709         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Couldn&#39;t open file: &#39;&quot;</span> + cnvRegionFile + <span class="stringliteral">&quot;&#39; to read.&quot;</span>);
<a name="l00710"></a>00710     <span class="keywordflow">if</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#adabcde206ca5a68ea3a983dfaca0d8f0" title="Advance to the next header matching key ///.">headersFindNext</a>(<span class="stringliteral">&quot;genome-version&quot;</span>, genomeVersion) != TSV_OK)
<a name="l00711"></a>00711         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Region file is missing &#39;genome-version&#39; meta info.&quot;</span>);
<a name="l00712"></a>00712     tsv.<a class="code" href="classaffx_1_1TsvFile.html#ae7932be2156c04a562f327b53833aed7" title="Close the file.">close</a>();
<a name="l00713"></a>00713     <span class="keywordflow">return</span> genomeVersion;
<a name="l00714"></a>00714 }
<a name="l00715"></a>00715 
<a name="l00716"></a>00716 <span class="keywordtype">void</span> CanaryEngine::check_input_file_headers(vector&lt;string&gt; chipTypes, 
<a name="l00717"></a>00717                                             vector&lt;string&gt; files, 
<a name="l00718"></a>00718                                             <span class="keywordtype">string</span> &amp;mapName, 
<a name="l00719"></a>00719                                             <span class="keywordtype">string</span> &amp;mapVersion, <span class="keywordtype">bool</span> force) {
<a name="l00720"></a>00720     <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">TsvFile</a> tsv;
<a name="l00721"></a>00721     <span class="keywordflow">if</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#a763ce0bbf19b4134d0445aa58e0f5011" title="Opens a file -- attempts to guess some defaults.">open</a>(files[0]) != TSV_OK)
<a name="l00722"></a>00722         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Couldn&#39;t open file: &#39;&quot;</span> + files[0] + <span class="stringliteral">&quot;&#39; to read.&quot;</span>);
<a name="l00723"></a>00723     <span class="keywordflow">if</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#adabcde206ca5a68ea3a983dfaca0d8f0" title="Advance to the next header matching key ///.">headersFindNext</a>(<span class="stringliteral">&quot;map-name&quot;</span>, mapName) != TSV_OK)
<a name="l00724"></a>00724         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;File &#39;&quot;</span> + files[0] + <span class="stringliteral">&quot;&#39; is missing &#39;map-name&#39; meta info.&quot;</span>);
<a name="l00725"></a>00725     <span class="keywordflow">if</span> (tsv.<a class="code" href="classaffx_1_1TsvFile.html#adabcde206ca5a68ea3a983dfaca0d8f0" title="Advance to the next header matching key ///.">headersFindNext</a>(<span class="stringliteral">&quot;map-version&quot;</span>, mapVersion) != TSV_OK)
<a name="l00726"></a>00726         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;File &#39;&quot;</span> + files[0] + <span class="stringliteral">&quot;&#39; is missing &#39;map-version&#39; meta info.&quot;</span>);
<a name="l00727"></a>00727     tsv.<a class="code" href="classaffx_1_1TsvFile.html#ae7932be2156c04a562f327b53833aed7" title="Close the file.">close</a>();
<a name="l00728"></a>00728 
<a name="l00729"></a>00729     <span class="keywordflow">if</span> (force)
<a name="l00730"></a>00730         <span class="keywordflow">return</span>;
<a name="l00731"></a>00731 
<a name="l00732"></a>00732     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i &lt; files.size(); i++) {
<a name="l00733"></a>00733         <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">TsvFile</a> tsv2;
<a name="l00734"></a>00734         <span class="keywordtype">string</span> val;
<a name="l00735"></a>00735         <span class="keywordflow">if</span> (tsv2.<a class="code" href="classaffx_1_1TsvFile.html#a763ce0bbf19b4134d0445aa58e0f5011" title="Opens a file -- attempts to guess some defaults.">open</a>(files[i]) != TSV_OK)
<a name="l00736"></a>00736             <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Couldn&#39;t open file: &#39;&quot;</span> + files[i] + <span class="stringliteral">&quot;&#39; to read.&quot;</span>);
<a name="l00737"></a>00737         <span class="keywordflow">if</span> (tsv2.<a class="code" href="classaffx_1_1TsvFile.html#adabcde206ca5a68ea3a983dfaca0d8f0" title="Advance to the next header matching key ///.">headersFindNext</a>(<span class="stringliteral">&quot;map-name&quot;</span>, val) != TSV_OK)
<a name="l00738"></a>00738             <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;File &#39;&quot;</span> + files[i] + 
<a name="l00739"></a>00739                           <span class="stringliteral">&quot;&#39; is missing &#39;map-name&#39; meta info.&quot;</span>);
<a name="l00740"></a>00740         <span class="keywordflow">if</span> (val != mapName)
<a name="l00741"></a>00741             <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;File &#39;&quot;</span> + files[i] + <span class="stringliteral">&quot;&#39; has map-name &#39;&quot;</span> + val + 
<a name="l00742"></a>00742                           <span class="stringliteral">&quot;&#39;. Expecting &#39;&quot;</span> + mapName + <span class="stringliteral">&quot;&#39;.&quot;</span>);
<a name="l00743"></a>00743         <span class="keywordflow">if</span> (tsv2.<a class="code" href="classaffx_1_1TsvFile.html#adabcde206ca5a68ea3a983dfaca0d8f0" title="Advance to the next header matching key ///.">headersFindNext</a>(<span class="stringliteral">&quot;map-version&quot;</span>, val) != TSV_OK)
<a name="l00744"></a>00744             <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;File &#39;&quot;</span> + files[i] + 
<a name="l00745"></a>00745                           <span class="stringliteral">&quot;&#39; is missing &#39;map-version&#39; meta info.&quot;</span>);
<a name="l00746"></a>00746         <span class="keywordflow">if</span> (val != mapVersion)
<a name="l00747"></a>00747             <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;File &#39;&quot;</span> + files[i] + <span class="stringliteral">&quot;&#39; has map-version &#39;&quot;</span> + val + 
<a name="l00748"></a>00748                           <span class="stringliteral">&quot;&#39;. Expecting &#39;&quot;</span> + mapVersion + <span class="stringliteral">&quot;&#39;.&quot;</span>);
<a name="l00749"></a>00749         tsv2.<a class="code" href="classaffx_1_1TsvFile.html#ae7932be2156c04a562f327b53833aed7" title="Close the file.">close</a>();
<a name="l00750"></a>00750 
<a name="l00751"></a>00751     }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; files.size(); i++)
<a name="l00754"></a>00754         <a class="code" href="classEngineUtil.html#a44f506207f128da78d1c8ba67ab47de2" title="Check chip types in TSV file against those in vector.">EngineUtil::checkTsvFileChipType</a>(files[i],chipTypes,<span class="keyword">true</span>);
<a name="l00755"></a>00755 }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757 <span class="keywordtype">void</span> CanaryEngine::read_region_file(<span class="keywordtype">string</span> cnvRegionFile, 
<a name="l00758"></a>00758                                     map&lt;<span class="keywordtype">string</span>,vector&lt;string&gt; &gt; &amp;cnv_region_map,
<a name="l00759"></a>00759                                     vector&lt;string&gt; &amp;cnv_region_names) {
<a name="l00760"></a>00760   
<a name="l00761"></a>00761     <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">TsvFile</a> regionfile;
<a name="l00762"></a>00762 
<a name="l00763"></a>00763     <span class="keywordtype">string</span> cnv_region;
<a name="l00764"></a>00764 
<a name="l00765"></a>00765     regionfile.bind(0,<span class="stringliteral">&quot;cnv_region&quot;</span>,&amp;cnv_region, <a class="code" href="namespaceaffx.html#a8f36853f1d3b6cfb79edebd82760691daf605fbe0e244c4a604d176991d8df2c6" title="warn if not bound">TSV_BIND_REQUIRED</a>);
<a name="l00766"></a>00766 
<a name="l00767"></a>00767     <span class="keywordflow">if</span> (regionfile.<a class="code" href="classaffx_1_1TsvFile.html#a763ce0bbf19b4134d0445aa58e0f5011" title="Opens a file -- attempts to guess some defaults.">open</a>(cnvRegionFile) != TSV_OK)
<a name="l00768"></a>00768         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Couldn&#39;t open file: &#39;&quot;</span> + cnvRegionFile + <span class="stringliteral">&quot;&#39; to read.&quot;</span>);
<a name="l00769"></a>00769 
<a name="l00770"></a>00770 
<a name="l00771"></a>00771     <span class="keywordflow">if</span> (regionfile.<a class="code" href="classaffx_1_1TsvFile.html#a2dbd33415a815e221ae61cf3feac5500" title="Covert a column index to a column index ///.">cname2cidx</a>(0,<span class="stringliteral">&quot;cn_probeset_ids&quot;</span>) == TSV_ERR_NOTFOUND)
<a name="l00772"></a>00772         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;cn_probeset_ids column is missing from regions file&quot;</span>);
<a name="l00773"></a>00773     <span class="keywordflow">if</span> (regionfile.<a class="code" href="classaffx_1_1TsvFile.html#a2dbd33415a815e221ae61cf3feac5500" title="Covert a column index to a column index ///.">cname2cidx</a>(0,<span class="stringliteral">&quot;snp_probeset_ids&quot;</span>) == TSV_ERR_NOTFOUND)
<a name="l00774"></a>00774         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;snp_probeset_ids column is missing from regions file&quot;</span>);
<a name="l00775"></a>00775 
<a name="l00776"></a>00776     <span class="comment">// Run through the region file</span>
<a name="l00777"></a>00777     <span class="keywordflow">while</span> (regionfile.<a class="code" href="classaffx_1_1TsvFile.html#a2022895d082d1d635e7f59fccab12afb" title="Skip to the next level of data which matches seek_clvl ///.">nextLevel</a>(0)==TSV_OK) {
<a name="l00778"></a>00778         vector&lt;string&gt;cn_probes;
<a name="l00779"></a>00779         vector&lt;string&gt;snp_probes;
<a name="l00780"></a>00780 
<a name="l00781"></a>00781         <span class="comment">// split up probesets</span>
<a name="l00782"></a>00782         regionfile.<a class="code" href="classaffx_1_1TsvFile.html#a7a81092ce134e8c9116a1a5bcfe287d1" title="Get the string value of a field ///.">get</a>(0,<span class="stringliteral">&quot;cn_probeset_ids&quot;</span>,&amp;cn_probes);
<a name="l00783"></a>00783         regionfile.<a class="code" href="classaffx_1_1TsvFile.html#a7a81092ce134e8c9116a1a5bcfe287d1" title="Get the string value of a field ///.">get</a>(0,<span class="stringliteral">&quot;snp_probeset_ids&quot;</span>,&amp;snp_probes);
<a name="l00784"></a>00784 
<a name="l00785"></a>00785         cnv_region_names.push_back(cnv_region);
<a name="l00786"></a>00786 <span class="comment"></span>
<a name="l00787"></a>00787 <span class="comment">        ///@todo need to check that the entries in regions file are</span>
<a name="l00788"></a>00788 <span class="comment"></span>        <span class="comment">//unique given our use of maps.</span>
<a name="l00789"></a>00789         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;cn_probes.size(); k++)
<a name="l00790"></a>00790             cnv_region_map[cnv_region].push_back(cn_probes[k]);
<a name="l00791"></a>00791         
<a name="l00792"></a>00792         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;snp_probes.size(); k++)
<a name="l00793"></a>00793             cnv_region_map[cnv_region].push_back(snp_probes[k]);
<a name="l00794"></a>00794     }
<a name="l00795"></a>00795     regionfile.<a class="code" href="classaffx_1_1TsvFile.html#ae7932be2156c04a562f327b53833aed7" title="Close the file.">close</a>();
<a name="l00796"></a>00796 }
<a name="l00797"></a>00797 
<a name="l00798"></a>00798 <span class="keywordtype">void</span> CanaryEngine::writeCnvSummaries(<a class="code" href="classCanaryOptions.html" title="Place to group program options.">CanaryOptions</a> &amp;opts, 
<a name="l00799"></a>00799                                      map&lt;<span class="keywordtype">string</span>,vector&lt;string&gt; &gt; &amp;cnv_region_map) {
<a name="l00800"></a>00800     <span class="comment">// Now it is time to read the probe summaries back in</span>
<a name="l00801"></a>00801 
<a name="l00802"></a>00802     <span class="comment">//OPTIONS</span>
<a name="l00803"></a>00803     <span class="keywordtype">string</span> probedatafilename = <a class="code" href="classFs.html#af44351abee4cbc47f94b83cb2f62899f" title="join strings with the path sep. /// while we would want people to keep the path with FsPath...">Fs::join</a>(opts.outDir, opts.setAnalysisName + <span class="stringliteral">&quot;.allele_average_summary.txt&quot;</span>);
<a name="l00804"></a>00804 
<a name="l00805"></a>00805     <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">TsvFile</a> probedatafile;
<a name="l00806"></a>00806     <span class="keywordflow">if</span> (probedatafile.<a class="code" href="classaffx_1_1TsvFile.html#a763ce0bbf19b4134d0445aa58e0f5011" title="Opens a file -- attempts to guess some defaults.">open</a>(probedatafilename) != TSV_OK)
<a name="l00807"></a>00807         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Unable to open probe data file &#39;&quot;</span> + 
<a name="l00808"></a>00808                       probedatafilename + <span class="stringliteral">&quot;&#39;&quot;</span>);
<a name="l00809"></a>00809     <span class="keywordtype">int</span> ncol = probedatafile.<a class="code" href="classaffx_1_1TsvFile.html#a94ad901d12ab05cce0f050f99665970f" title="The number of columns for this level ///.">getColumnCount</a>(0);
<a name="l00810"></a>00810 
<a name="l00811"></a>00811     <span class="comment">// save for the header of the output file</span>
<a name="l00812"></a>00812     vector&lt;string&gt;celfnames;
<a name="l00813"></a>00813     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i&lt;ncol; i++) {
<a name="l00814"></a>00814         <span class="keywordtype">string</span> cname = probedatafile.getColumnName(0,i);
<a name="l00815"></a>00815         celfnames.push_back(cname);
<a name="l00816"></a>00816     }
<a name="l00817"></a>00817 
<a name="l00818"></a>00818     map&lt;string,valarray&lt;double&gt; &gt; probe_data_map; 
<a name="l00819"></a>00819     <span class="keywordflow">while</span> (probedatafile.<a class="code" href="classaffx_1_1TsvFile.html#a2022895d082d1d635e7f59fccab12afb" title="Skip to the next level of data which matches seek_clvl ///.">nextLevel</a>(0)==TSV_OK) {
<a name="l00820"></a>00820         <span class="keywordtype">string</span> probe_name;
<a name="l00821"></a>00821         valarray&lt;double&gt;values(ncol-1);
<a name="l00822"></a>00822         probedatafile.<a class="code" href="classaffx_1_1TsvFile.html#a7a81092ce134e8c9116a1a5bcfe287d1" title="Get the string value of a field ///.">get</a>(0,0,probe_name);
<a name="l00823"></a>00823         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i&lt;ncol; i++) probedatafile.<a class="code" href="classaffx_1_1TsvFile.html#a7a81092ce134e8c9116a1a5bcfe287d1" title="Get the string value of a field ///.">get</a>(0,i,values[i-1]);
<a name="l00824"></a>00824         probe_data_map[probe_name].resize(ncol-1);
<a name="l00825"></a>00825         probe_data_map[probe_name] = values;
<a name="l00826"></a>00826     }
<a name="l00827"></a>00827     probedatafile.<a class="code" href="classaffx_1_1TsvFile.html#ae7932be2156c04a562f327b53833aed7" title="Close the file.">close</a>();
<a name="l00828"></a>00828 
<a name="l00829"></a>00829     <span class="comment">// In the future this should not be the spot to make a temporary</span>
<a name="l00830"></a>00830     <span class="comment">// file disappear.  Leave it here until the code is reorganised to</span>
<a name="l00831"></a>00831     <span class="comment">// flow.</span>
<a name="l00832"></a>00832     <span class="keywordflow">if</span> (!opts.tableOutput)
<a name="l00833"></a>00833         <a class="code" href="classFs.html#a6b8f232817f933a42c21edde6ea55a3a" title="An error if it doesnt exist.">Fs::rm</a>(probedatafilename, <span class="keyword">false</span>);
<a name="l00834"></a>00834 
<a name="l00835"></a>00835 
<a name="l00836"></a>00836     <span class="comment">// get chip intensities for normalization</span>
<a name="l00837"></a>00837     set&lt;string&gt;normalization_psets =
<a name="l00838"></a>00838         get_normalization_psets(opts.cnvNormFile);
<a name="l00839"></a>00839 
<a name="l00840"></a>00840     Matrix normdata;
<a name="l00841"></a>00841     normdata.ReSize(normalization_psets.size(),ncol-1);
<a name="l00842"></a>00842 
<a name="l00843"></a>00843 
<a name="l00844"></a>00844     <span class="keywordtype">int</span> ncount=0;
<a name="l00845"></a>00845     <span class="keywordflow">for</span> (set&lt;string&gt;::iterator iter=normalization_psets.begin();
<a name="l00846"></a>00846          iter!=normalization_psets.end(); iter++) {
<a name="l00847"></a>00847         valarray&lt;double&gt;vec = probe_data_map[*iter];
<a name="l00848"></a>00848         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k=0; k&lt;vec.size(); k++)
<a name="l00849"></a>00849             normdata.element(ncount,k) = vec[k];
<a name="l00850"></a>00850         ncount++;
<a name="l00851"></a>00851     }
<a name="l00852"></a>00852 
<a name="l00853"></a>00853     <span class="comment">// Need to find a consistent way of assigning sizes</span>
<a name="l00854"></a>00854     valarray&lt;double&gt;nvalues(normdata.Nrows());
<a name="l00855"></a>00855     valarray&lt;double&gt;norm_factor(normdata.Ncols());
<a name="l00856"></a>00856 
<a name="l00857"></a>00857     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;normdata.Ncols(); j++) {
<a name="l00858"></a>00858         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;normdata.Nrows(); i++)
<a name="l00859"></a>00859             nvalues[i] = normdata.element(i,j);
<a name="l00860"></a>00860 
<a name="l00861"></a>00861         norm_factor[j] = compute_median(nvalues);
<a name="l00862"></a>00862     }
<a name="l00863"></a>00863 
<a name="l00864"></a>00864 
<a name="l00865"></a>00865     <span class="comment">//OPTIONS</span>
<a name="l00866"></a>00866     <span class="keywordtype">string</span> cnvdatafilename = <a class="code" href="classFs.html#af44351abee4cbc47f94b83cb2f62899f" title="join strings with the path sep. /// while we would want people to keep the path with FsPath...">Fs::join</a>(opts.outDir, opts.setAnalysisName + <span class="stringliteral">&quot;.cnv_region_summary.txt&quot;</span>);
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">TsvFile</a> cnvdatafile;
<a name="l00869"></a>00869 
<a name="l00870"></a>00870     <span class="comment">// Define the column names from the old file</span>
<a name="l00871"></a>00871     cnvdatafile.<a class="code" href="classaffx_1_1TsvFile.html#aadc22863a63b9c6588b0f2dc61875809" title="User methods.">defineColumn</a>(0,0,<span class="stringliteral">&quot;cnv_region_id&quot;</span>); <span class="comment">// just to have it defined</span>
<a name="l00872"></a>00872     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i&lt;ncol; i++) cnvdatafile.<a class="code" href="classaffx_1_1TsvFile.html#aadc22863a63b9c6588b0f2dc61875809" title="User methods.">defineColumn</a>(0,i,celfnames[i-1]);
<a name="l00873"></a>00873     cnvdatafile.<a class="code" href="classaffx_1_1TsvFile.html#a1903489904b4e2f8f2a262b8f10cdb0e" title="Set the options up for &amp;quot;tsv&amp;quot; format and write the tsv-v1 header ///.">writeTsv_v1</a>(cnvdatafilename);
<a name="l00874"></a>00874 
<a name="l00875"></a>00875     <span class="comment">// Build and median polish a matrix for each CNV region.</span><span class="comment"></span>
<a name="l00876"></a>00876 <span class="comment">    ///@todo output in same order as the regions file -- rather than the order returned by map</span>
<a name="l00877"></a>00877 <span class="comment"></span>    <span class="keywordflow">for</span> (map&lt;<span class="keywordtype">string</span>,vector&lt;string&gt; &gt;::iterator iter=cnv_region_map.begin();
<a name="l00878"></a>00878          iter!=cnv_region_map.end(); iter++) {
<a name="l00879"></a>00879         <span class="keywordtype">string</span> cnv_region = iter-&gt;first;
<a name="l00880"></a>00880         vector&lt;string&gt; probe_names = iter-&gt;second;
<a name="l00881"></a>00881         
<a name="l00882"></a>00882         <span class="keywordtype">int</span> N = ncol - 1;
<a name="l00883"></a>00883         <span class="keywordtype">int</span> P = int(probe_names.size());
<a name="l00884"></a>00884         
<a name="l00885"></a>00885         
<a name="l00886"></a>00886         Matrix the_data;
<a name="l00887"></a>00887         the_data.ReSize(N,P);
<a name="l00888"></a>00888         
<a name="l00889"></a>00889         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;P; j++) {
<a name="l00890"></a>00890             valarray&lt;double&gt; vals = probe_data_map[probe_names[j]];
<a name="l00891"></a>00891             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;N; i++)
<a name="l00892"></a>00892                 the_data.element(i,j) = log(vals[i]/norm_factor[i]);
<a name="l00893"></a>00893         }
<a name="l00894"></a>00894         
<a name="l00895"></a>00895         valarray&lt;double&gt;cnv_summaries = median_polish(the_data);
<a name="l00896"></a>00896         
<a name="l00897"></a>00897         cnvdatafile.set(0,0,cnv_region);
<a name="l00898"></a>00898         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;N; i++)
<a name="l00899"></a>00899             cnvdatafile.set(0,i+1,exp(cnv_summaries[i]));
<a name="l00900"></a>00900         cnvdatafile.<a class="code" href="classaffx_1_1TsvFile.html#a2a459be42bea9ea3f180773370ec0de7" title="Write a level of data to the file. ///.">writeLevel</a>(0);
<a name="l00901"></a>00901     }
<a name="l00902"></a>00902     
<a name="l00903"></a>00903     cnvdatafile.<a class="code" href="classaffx_1_1TsvFile.html#ae7932be2156c04a562f327b53833aed7" title="Close the file.">close</a>();
<a name="l00904"></a>00904 }
<a name="l00905"></a>00905 
<a name="l00906"></a>00906 <span class="comment">/*</span>
<a name="l00907"></a>00907 <span class="comment"> *  The main function for computing canary.</span>
<a name="l00908"></a>00908 <span class="comment"> */</span>
<a name="l00909"></a>00909 
<a name="l00910"></a>00910 <span class="comment">//----------------------------------------------</span>
<a name="l00911"></a>00911 
<a name="l00912"></a>00912 
<a name="l00913"></a>00913 <span class="keywordtype">void</span> CanaryEngine::mainCanary(<a class="code" href="classCanaryOptions.html" title="Place to group program options.">CanaryOptions</a> &amp;opts, 
<a name="l00914"></a>00914                               map&lt;<span class="keywordtype">string</span>,vector&lt;string&gt; &gt; &amp;cnv_region_map, 
<a name="l00915"></a>00915                               vector&lt;string&gt; &amp;cnv_region_names) {
<a name="l00916"></a>00916     <span class="keywordtype">string</span> cnvdatafilename = <a class="code" href="classFs.html#af44351abee4cbc47f94b83cb2f62899f" title="join strings with the path sep. /// while we would want people to keep the path with FsPath...">Fs::join</a>(opts.outDir,opts.setAnalysisName + <span class="stringliteral">&quot;.cnv_region_summary.txt&quot;</span>);
<a name="l00917"></a>00917 
<a name="l00918"></a>00918     <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(1,<span class="stringliteral">&quot;Loading up CNV region signals&quot;</span>);
<a name="l00919"></a>00919     pair&lt;list&lt;string&gt;,map&lt;string,valarray&lt;double&gt; &gt; &gt;
<a name="l00920"></a>00920         intensity_pair = load_broad_intensity_map(cnvdatafilename);
<a name="l00921"></a>00921 
<a name="l00922"></a>00922     <span class="comment">// The CNV intensity data</span>
<a name="l00923"></a>00923     map&lt;string,valarray&lt;double&gt; &gt; intensity_map = intensity_pair.second;
<a name="l00924"></a>00924 
<a name="l00925"></a>00925     <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(1,<span class="stringliteral">&quot;Loading up CNV region priors&quot;</span>);
<a name="l00926"></a>00926     map&lt;string,CanaryPrior&gt; prior_map =
<a name="l00927"></a>00927         load_broad_prior_map(opts.canaryPriorFile);
<a name="l00928"></a>00928 
<a name="l00929"></a>00929     map&lt;string,vector&lt;int&gt; &gt; call_map;
<a name="l00930"></a>00930     map&lt;string,vector&lt;double&gt; &gt; confidence_map;
<a name="l00931"></a>00931 
<a name="l00932"></a>00932     <span class="comment">// Go through all of the CNV regions</span>
<a name="l00933"></a>00933     <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(1,<span class="stringliteral">&quot;Processing CNV regions&quot;</span>);<span class="comment"></span>
<a name="l00934"></a>00934 <span class="comment">    ///@todo process in same order as the regions file -- rather than the order returned by map</span>
<a name="l00935"></a>00935 <span class="comment"></span>    <span class="keywordflow">for</span> (map&lt;<span class="keywordtype">string</span>,valarray&lt;double&gt; &gt;::iterator iter=intensity_map.begin();
<a name="l00936"></a>00936          iter!=intensity_map.end(); iter++) {
<a name="l00937"></a>00937         <span class="keywordtype">string</span> cnv_region = iter-&gt;first;
<a name="l00938"></a>00938 <span class="comment">//herehere</span>
<a name="l00939"></a>00939 <span class="comment">//              if (cnv_region != &quot;CNP1682&quot;) continue; // handy for isolating a CNV</span>
<a name="l00940"></a>00940 <span class="comment">//              if (cnv_region != &quot;CNP12034&quot;) continue; // handy for isolating a CNV</span>
<a name="l00941"></a>00941 <span class="comment">//              if (cnv_region != &quot;CNP10276&quot;) continue; // handy for isolating a CNV</span>
<a name="l00942"></a>00942 
<a name="l00943"></a>00943         <a class="code" href="classCanaryPrior.html">CanaryPrior</a> CP = prior_map[cnv_region];
<a name="l00944"></a>00944         valarray&lt;double&gt;vals = intensity_map[cnv_region];
<a name="l00945"></a>00945         <a class="code" href="classCanaryWithPrior.html">CanaryWithPrior</a> CWP(opts,vals,CP);
<a name="l00946"></a>00946 
<a name="l00947"></a>00947         <span class="keywordtype">string</span> best_model = CWP.best_fit();
<a name="l00948"></a>00948 
<a name="l00949"></a>00949         <a class="code" href="classBroadEstepper1.html" title="Translation from R to C++ of the Broad&amp;#39;s expectation step.">BroadEstepper1</a> best_model_BE = CWP.fitted_values(best_model);
<a name="l00950"></a>00950         valarray&lt;double&gt;bmeans = best_model_BE.<a class="code" href="classBroadEstepper1.html#aa4fd9ac7ce9658377ecd015a66e244cf">mean</a>();
<a name="l00951"></a>00951 
<a name="l00952"></a>00952         vector&lt;double&gt;confidences =
<a name="l00953"></a>00953             CWP.fitted_values(best_model).confidences();
<a name="l00954"></a>00954 
<a name="l00955"></a>00955         pair&lt;string,BroadEstepper1&gt; model_pair(best_model,best_model_BE);
<a name="l00956"></a>00956 
<a name="l00957"></a>00957         <a class="code" href="classBroadEstepper1.html" title="Translation from R to C++ of the Broad&amp;#39;s expectation step.">BroadEstepper1</a> newBE = directional_impute(opts,model_pair,CP);
<a name="l00958"></a>00958 
<a name="l00959"></a>00959         <span class="comment">// tweak the variances</span>
<a name="l00960"></a>00960 
<a name="l00961"></a>00961         valarray&lt;double&gt;newbevars = newBE.<a class="code" href="classBroadEstepper1.html#a370a1a74f3347bf17bae2578041cbd41">var</a>();
<a name="l00962"></a>00962         <span class="comment">//OPTIONS</span>
<a name="l00963"></a>00963         <span class="keywordtype">double</span> vartweak = newbevars.sum()/newbevars.size();
<a name="l00964"></a>00964         <span class="keywordtype">double</span> varshare = opts.tune_regularize_variance_factor;
<a name="l00965"></a>00965 
<a name="l00966"></a>00966 <span class="comment">//              newbevars = 0.6*newbevars + 0.4*vartweak;</span>
<a name="l00967"></a>00967         newbevars = (1.0 - varshare)*newbevars + varshare*vartweak;
<a name="l00968"></a>00968         newBE.<a class="code" href="classBroadEstepper1.html#a370a1a74f3347bf17bae2578041cbd41">var</a>(newbevars);
<a name="l00969"></a>00969         newBE.update_prob();
<a name="l00970"></a>00970 
<a name="l00971"></a>00971 <span class="comment">//              confidences = newBE.confidences();</span>
<a name="l00972"></a>00972         confidence_map[cnv_region] = newBE.confidences();
<a name="l00973"></a>00973         vector&lt;int&gt; assignments = newBE.assignments();
<a name="l00974"></a>00974         call_map[cnv_region] = assignments;
<a name="l00975"></a>00975     }
<a name="l00976"></a>00976 
<a name="l00977"></a>00977     <span class="keywordflow">if</span> (opts.ccMDChpOutput || opts.tableOutput) {
<a name="l00978"></a>00978         <a class="code" href="classVerbose.html#ac4034f68f4c8d2b49cd6340984b940ce" title="Print a message to the stream.">Verbose::out</a>(1,<span class="stringliteral">&quot;Generating output file(s).&quot;</span>);
<a name="l00979"></a>00979 
<a name="l00980"></a>00980         <span class="keywordtype">int</span> nregions = 0;
<a name="l00981"></a>00981         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;cnv_region_names.size(); i++)
<a name="l00982"></a>00982             <span class="keywordflow">if</span> (intensity_map.find(cnv_region_names[i]) != intensity_map.end()) 
<a name="l00983"></a>00983                 nregions++;
<a name="l00984"></a>00984 
<a name="l00985"></a>00985         <span class="keywordtype">int</span> max_rlen = 0;
<a name="l00986"></a>00986         <span class="keywordflow">for</span> (map&lt;<span class="keywordtype">string</span>,valarray&lt;double&gt; &gt;::iterator iter=intensity_map.begin();
<a name="l00987"></a>00987              iter!=intensity_map.end(); iter++) {
<a name="l00988"></a>00988             <span class="keywordflow">if</span> (iter-&gt;first.size() &gt; max_rlen) 
<a name="l00989"></a>00989                 max_rlen = (<span class="keywordtype">int</span>)iter-&gt;first.size();
<a name="l00990"></a>00990         }
<a name="l00991"></a>00991    
<a name="l00992"></a>00992 
<a name="l00993"></a>00993         <span class="comment">// What meta info do we want to dump</span>
<a name="l00994"></a>00994         vector&lt;string&gt; hNames;
<a name="l00995"></a>00995         vector&lt;string&gt; hVals;
<a name="l00996"></a>00996         hNames.push_back(<span class="stringliteral">&quot;apt-engine&quot;</span>);                 hVals.push_back(<span class="stringliteral">&quot;CanaryEngine&quot;</span>);
<a name="l00997"></a>00997         hNames.push_back(<span class="stringliteral">&quot;apt-program-name&quot;</span>);           hVals.push_back(opts.progName);
<a name="l00998"></a>00998         hNames.push_back(<span class="stringliteral">&quot;apt-command-line&quot;</span>);           hVals.push_back(opts.commandLine);
<a name="l00999"></a>00999         hNames.push_back(<span class="stringliteral">&quot;apt-exec-guid&quot;</span>);              hVals.push_back(opts.execGuid);
<a name="l01000"></a>01000         hNames.push_back(<span class="stringliteral">&quot;apt-analysis-guid&quot;</span>);          hVals.push_back(<a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;analysis-guid&quot;</span>));
<a name="l01001"></a>01001         hNames.push_back(<span class="stringliteral">&quot;apt-time-str&quot;</span>);               hVals.push_back(opts.timeStr);
<a name="l01002"></a>01002         hNames.push_back(<span class="stringliteral">&quot;apt-version&quot;</span>);                hVals.push_back(opts.version);
<a name="l01003"></a>01003         hNames.push_back(<span class="stringliteral">&quot;apt-cvs-id&quot;</span>);                 hVals.push_back(opts.cvsId);
<a name="l01004"></a>01004         hNames.push_back(<span class="stringliteral">&quot;apt-free-mem&quot;</span>);               hVals.push_back(<a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(opts.freeMemAtStart));
<a name="l01005"></a>01005         hNames.push_back(<span class="stringliteral">&quot;apt-opt-genome-version&quot;</span>);     hVals.push_back(opts.genomeVersion);
<a name="l01006"></a>01006         hNames.push_back(<span class="stringliteral">&quot;apt-opt-force&quot;</span>);              hVals.push_back(<a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(opts.force));
<a name="l01007"></a>01007         hNames.push_back(<span class="stringliteral">&quot;apt-opt-chip-type&quot;</span>);          hVals.push_back(opts.chipType);
<a name="l01008"></a>01008         hNames.push_back(<span class="stringliteral">&quot;apt-opt-out-dir&quot;</span>);            hVals.push_back(opts.outDir);
<a name="l01009"></a>01009         hNames.push_back(<span class="stringliteral">&quot;apt-opt-cdf-file&quot;</span>);           hVals.push_back(<a class="code" href="classFs.html#a16925724086de1c12ea58bad4f8df75c" title="like the unix function of the same name. ///">Fs::basename</a>(opts.cdfFile));
<a name="l01010"></a>01010         hNames.push_back(<span class="stringliteral">&quot;apt-opt-spf-file&quot;</span>);           hVals.push_back(<a class="code" href="classFs.html#a16925724086de1c12ea58bad4f8df75c" title="like the unix function of the same name. ///">Fs::basename</a>(opts.spfFile));
<a name="l01011"></a>01011         hNames.push_back(<span class="stringliteral">&quot;apt-opt-map-file&quot;</span>);           hVals.push_back(<a class="code" href="classFs.html#a16925724086de1c12ea58bad4f8df75c" title="like the unix function of the same name. ///">Fs::basename</a>(opts.cnvMapFile));
<a name="l01012"></a>01012         hNames.push_back(<span class="stringliteral">&quot;apt-opt-region-file&quot;</span>);        hVals.push_back(<a class="code" href="classFs.html#a16925724086de1c12ea58bad4f8df75c" title="like the unix function of the same name. ///">Fs::basename</a>(opts.cnvRegionFile));
<a name="l01013"></a>01013         hNames.push_back(<span class="stringliteral">&quot;apt-opt-canary-norm-file&quot;</span>);   hVals.push_back(<a class="code" href="classFs.html#a16925724086de1c12ea58bad4f8df75c" title="like the unix function of the same name. ///">Fs::basename</a>(opts.cnvNormFile));
<a name="l01014"></a>01014         hNames.push_back(<span class="stringliteral">&quot;apt-opt-canary-prior-file&quot;</span>);  hVals.push_back(<a class="code" href="classFs.html#a16925724086de1c12ea58bad4f8df75c" title="like the unix function of the same name. ///">Fs::basename</a>(opts.canaryPriorFile));
<a name="l01015"></a>01015         hNames.push_back(<span class="stringliteral">&quot;apt-opt-analysis-name&quot;</span>);      hVals.push_back(opts.setAnalysisName);
<a name="l01016"></a>01016         hNames.push_back(<span class="stringliteral">&quot;apt-opt-map-name&quot;</span>);           hVals.push_back(opts.mapName);
<a name="l01017"></a>01017         hNames.push_back(<span class="stringliteral">&quot;apt-opt-map-version&quot;</span>);        hVals.push_back(opts.mapVersion);
<a name="l01018"></a>01018 
<a name="l01019"></a>01019         <span class="comment">// other headers from regions file meta data</span>
<a name="l01020"></a>01020         vector&lt;string&gt; keys;
<a name="l01021"></a>01021         vector&lt;string&gt; vals;
<a name="l01022"></a>01022         get_meta_tags(opts.cnvRegionFile, keys, vals);
<a name="l01023"></a>01023         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; keys.size(); i++) {
<a name="l01024"></a>01024             hNames.push_back(<span class="stringliteral">&quot;apt-opt-region-file-&quot;</span> + keys[i]);
<a name="l01025"></a>01025             hVals.push_back(vals[i]);
<a name="l01026"></a>01026         }
<a name="l01027"></a>01027 <span class="comment"></span>
<a name="l01028"></a>01028 <span class="comment">        ///@todo these should be the fully enumerated specs, not just what the user asked for -- ie use SelfDoc</span>
<a name="l01029"></a>01029 <span class="comment"></span>        hNames.push_back(<span class="stringliteral">&quot;apt-opt-analysis-spec&quot;</span>);  hVals.push_back(opts.aptSummarizeAnalysis);
<a name="l01030"></a>01030         hNames.push_back(<span class="stringliteral">&quot;apt-opt-canary-spec&quot;</span>);    hVals.push_back(opts.aptCanaryAnalysis);
<a name="l01031"></a>01031 
<a name="l01032"></a>01032         hNames.push_back(<span class="stringliteral">&quot;apt-opt-cel-count&quot;</span>);      hVals.push_back(<a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(opts.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>.size()));
<a name="l01033"></a>01033         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;opts.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>.size(); i++) {
<a name="l01034"></a>01034             hNames.push_back(<span class="stringliteral">&quot;apt-opt-cel-&quot;</span>+<a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(i+1)); hVals.push_back(<a class="code" href="classFs.html#a16925724086de1c12ea58bad4f8df75c" title="like the unix function of the same name. ///">Fs::basename</a>(opts.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>[i]));
<a name="l01035"></a>01035             <span class="keywordflow">if</span> (opts.<a class="code" href="classCanaryOptions.html#a86e37b85224cebcb7be4d0eef201b336" title="Cel files to analyze.">celGuids</a>[i].empty() == <span class="keyword">false</span>)
<a name="l01036"></a>01036                 hNames.push_back(<span class="stringliteral">&quot;apt-opt-cel-guid-&quot;</span>+<a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(i+1)); hVals.push_back(opts.<a class="code" href="classCanaryOptions.html#a86e37b85224cebcb7be4d0eef201b336" title="Cel files to analyze.">celGuids</a>[i]);
<a name="l01037"></a>01037         }
<a name="l01038"></a>01038 
<a name="l01039"></a>01039         <span class="keywordflow">if</span> (opts.tableOutput) {
<a name="l01040"></a>01040             <a class="code" href="classaffx_1_1TsvFile.html" title="A class for reading and writing Tab Seperated Value (TSV) files. /// See the TsvFile format document ...">TsvFile</a> tsvCall,tsvConf;
<a name="l01041"></a>01041             <span class="keywordtype">int</span> cidx = 0;
<a name="l01042"></a>01042             <span class="comment">// first column labels the CNP</span>
<a name="l01043"></a>01043 
<a name="l01044"></a>01044             tsvCall.<a class="code" href="classaffx_1_1TsvFile.html#aadc22863a63b9c6588b0f2dc61875809" title="User methods.">defineColumn</a>(0,cidx,<span class="stringliteral">&quot;cnv_region_id&quot;</span>,affx::TSV_TYPE_UNKNOWN);
<a name="l01045"></a>01045             tsvConf.<a class="code" href="classaffx_1_1TsvFile.html#aadc22863a63b9c6588b0f2dc61875809" title="User methods.">defineColumn</a>(0,cidx,<span class="stringliteral">&quot;cnv_region_id&quot;</span>,affx::TSV_TYPE_UNKNOWN);
<a name="l01046"></a>01046             cidx++;
<a name="l01047"></a>01047 
<a name="l01048"></a>01048             <span class="comment">// remaining columns labelled by cel files</span>
<a name="l01049"></a>01049             <span class="keywordflow">for</span> (list&lt;string&gt;::iterator iter=intensity_pair.first.begin();      
<a name="l01050"></a>01050                  iter!=intensity_pair.first.end(); iter++){
<a name="l01051"></a>01051                 tsvCall.<a class="code" href="classaffx_1_1TsvFile.html#aadc22863a63b9c6588b0f2dc61875809" title="User methods.">defineColumn</a>(0,cidx,*iter,affx::TSV_TYPE_UNKNOWN);
<a name="l01052"></a>01052                 tsvConf.<a class="code" href="classaffx_1_1TsvFile.html#aadc22863a63b9c6588b0f2dc61875809" title="User methods.">defineColumn</a>(0,cidx,*iter,affx::TSV_TYPE_UNKNOWN);
<a name="l01053"></a>01053                 tsvConf.setPrecision(0,cidx,opts.precision);
<a name="l01054"></a>01054                 cidx++;
<a name="l01055"></a>01055             }
<a name="l01056"></a>01056 
<a name="l01057"></a>01057             <span class="comment">// header info</span>
<a name="l01058"></a>01058             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;hNames.size(); i++) {
<a name="l01059"></a>01059                 tsvCall.<a class="code" href="classaffx_1_1TsvFile.html#a11a4bb7b3c796316bc5b758f42229557" title="Add a key-value to the headers plus its sort order. ///.">addHeader</a>(hNames[i],hVals[i]);
<a name="l01060"></a>01060                 tsvConf.<a class="code" href="classaffx_1_1TsvFile.html#a11a4bb7b3c796316bc5b758f42229557" title="Add a key-value to the headers plus its sort order. ///.">addHeader</a>(hNames[i],hVals[i]);
<a name="l01061"></a>01061             }
<a name="l01062"></a>01062 
<a name="l01063"></a>01063             <span class="comment">// @todo - Fix this up so it uses AnalysisInfo rather than writing directly to tsv</span>
<a name="l01064"></a>01064             vector&lt;pair&lt;string, string&gt; &gt; metaData = <a class="code" href="classBaseEngine.html#ac9fb139876b95877fb7412d0dc27cdd8" title="Get a vector of the key=value pairs specified via the &amp;quot;meta-data-info&amp;quot; parameters.">getMetaDataDescription</a>();
<a name="l01065"></a>01065             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; metaData.size(); i++) {
<a name="l01066"></a>01066               pair&lt;string,string&gt; p = metaData[i];
<a name="l01067"></a>01067               <span class="keywordtype">string</span> key = <span class="stringliteral">&quot;affymetrix-application-meta-data-info-&quot;</span> + p.first;
<a name="l01068"></a>01068               tsvCall.<a class="code" href="classaffx_1_1TsvFile.html#a11a4bb7b3c796316bc5b758f42229557" title="Add a key-value to the headers plus its sort order. ///.">addHeader</a>(key, p.second);
<a name="l01069"></a>01069               tsvConf.<a class="code" href="classaffx_1_1TsvFile.html#a11a4bb7b3c796316bc5b758f42229557" title="Add a key-value to the headers plus its sort order. ///.">addHeader</a>(key, p.second);
<a name="l01070"></a>01070             }
<a name="l01071"></a>01071 
<a name="l01072"></a>01072             <span class="keywordflow">if</span> (tsvCall.<a class="code" href="classaffx_1_1TsvFile.html#a1903489904b4e2f8f2a262b8f10cdb0e" title="Set the options up for &amp;quot;tsv&amp;quot; format and write the tsv-v1 header ///.">writeTsv_v1</a>(<a class="code" href="classFs.html#af44351abee4cbc47f94b83cb2f62899f" title="join strings with the path sep. /// while we would want people to keep the path with FsPath...">Fs::join</a>(opts.outDir, opts.setAnalysisName + <span class="stringliteral">&quot;.calls.txt&quot;</span>)) != TSV_OK) {
<a name="l01073"></a>01073                 <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Unable to open call file&quot;</span>);
<a name="l01074"></a>01074             }
<a name="l01075"></a>01075 
<a name="l01076"></a>01076             <span class="keywordflow">if</span> (tsvConf.<a class="code" href="classaffx_1_1TsvFile.html#a1903489904b4e2f8f2a262b8f10cdb0e" title="Set the options up for &amp;quot;tsv&amp;quot; format and write the tsv-v1 header ///.">writeTsv_v1</a>(<a class="code" href="classFs.html#af44351abee4cbc47f94b83cb2f62899f" title="join strings with the path sep. /// while we would want people to keep the path with FsPath...">Fs::join</a>(opts.outDir, opts.setAnalysisName + <span class="stringliteral">&quot;.confidences.txt&quot;</span>)) != TSV_OK) {
<a name="l01077"></a>01077                 <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Unable to open confidences file&quot;</span>);
<a name="l01078"></a>01078             }
<a name="l01079"></a>01079 <span class="comment"></span>
<a name="l01080"></a>01080 <span class="comment">            ///@todo process in same order as the regions file -- rather than the order returned by map</span>
<a name="l01081"></a>01081 <span class="comment"></span>            <span class="keywordflow">for</span> (map&lt;<span class="keywordtype">string</span>,valarray&lt;double&gt; &gt;::iterator iter=intensity_map.begin();
<a name="l01082"></a>01082                  iter!=intensity_map.end(); iter++) {
<a name="l01083"></a>01083                 <span class="comment">// give the CNP name</span>
<a name="l01084"></a>01084                 tsvCall.set(0,0,iter-&gt;first);
<a name="l01085"></a>01085                 tsvConf.set(0,0,iter-&gt;first);
<a name="l01086"></a>01086                 
<a name="l01087"></a>01087                 <span class="comment">// give the calls or confidences for the CNP</span>
<a name="l01088"></a>01088                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;opts.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>.size(); i++) {
<a name="l01089"></a>01089                     tsvCall.set(0,i+1,(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)call_map[iter-&gt;first][i]);
<a name="l01090"></a>01090                     tsvConf.set(0,i+1,(<span class="keywordtype">float</span>)confidence_map[iter-&gt;first][i]);
<a name="l01091"></a>01091                 }
<a name="l01092"></a>01092                 
<a name="l01093"></a>01093                 <span class="comment">// write them out</span>
<a name="l01094"></a>01094                 tsvCall.<a class="code" href="classaffx_1_1TsvFile.html#a2a459be42bea9ea3f180773370ec0de7" title="Write a level of data to the file. ///.">writeLevel</a>(0);
<a name="l01095"></a>01095                 tsvConf.<a class="code" href="classaffx_1_1TsvFile.html#a2a459be42bea9ea3f180773370ec0de7" title="Write a level of data to the file. ///.">writeLevel</a>(0);
<a name="l01096"></a>01096                 
<a name="l01097"></a>01097             }
<a name="l01098"></a>01098             tsvCall.<a class="code" href="classaffx_1_1TsvFile.html#ae7932be2156c04a562f327b53833aed7" title="Close the file.">close</a>();
<a name="l01099"></a>01099             tsvConf.<a class="code" href="classaffx_1_1TsvFile.html#ae7932be2156c04a562f327b53833aed7" title="Close the file.">close</a>();
<a name="l01100"></a>01100         }
<a name="l01101"></a>01101 
<a name="l01102"></a>01102         <span class="keywordflow">if</span> (opts.ccMDChpOutput) {
<a name="l01103"></a>01103             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k=0; k&lt;opts.<a class="code" href="classCanaryOptions.html#a9e2925bcefd1829244322a6fc5ffa3de" title="CHP files to analyze.">chpFiles</a>.size(); k++) {
<a name="l01104"></a>01104                 <span class="keywordflow">try</span> {
<a name="l01105"></a>01105                     ParameterNameValueTypeList params;
<a name="l01106"></a>01106                     <a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html">ParameterNameValueType</a> param;
<a name="l01107"></a>01107 
<a name="l01108"></a>01108                     <a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataData.html">CHPMultiDataData</a> CHPMDD(opts.<a class="code" href="classCanaryOptions.html#a9e2925bcefd1829244322a6fc5ffa3de" title="CHP files to analyze.">chpFiles</a>[k]);
<a name="l01109"></a>01109     
<a name="l01110"></a>01110                     CHPMDD.SetArrayType(StringUtils::ConvertMBSToWCS(opts.chipType));
<a name="l01111"></a>01111                     CHPMDD.SetAlgName(L<span class="stringliteral">&quot;canary&quot;</span>);
<a name="l01112"></a>01112                     CHPMDD.SetAlgVersion(L<span class="stringliteral">&quot;1.0&quot;</span>);
<a name="l01113"></a>01113 
<a name="l01114"></a>01114                     param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ac2eb9ad835d3a8845385811f98ea9f2a">SetName</a>(L<span class="stringliteral">&quot;program-name&quot;</span>);
<a name="l01115"></a>01115                     param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a0b91a700f3a0cad9e04bd443d27f4dc3">SetValueText</a>(StringUtils::ConvertMBSToWCS(opts.progName));
<a name="l01116"></a>01116                     CHPMDD.GetGenericData().Header().GetGenericDataHdr()-&gt;AddNameValParam(param);
<a name="l01117"></a>01117                     param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ac2eb9ad835d3a8845385811f98ea9f2a">SetName</a>(L<span class="stringliteral">&quot;program-version&quot;</span>);
<a name="l01118"></a>01118                     param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a0b91a700f3a0cad9e04bd443d27f4dc3">SetValueText</a>(StringUtils::ConvertMBSToWCS(opts.version));
<a name="l01119"></a>01119                     CHPMDD.GetGenericData().Header().GetGenericDataHdr()-&gt;AddNameValParam(param);
<a name="l01120"></a>01120                     param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ac2eb9ad835d3a8845385811f98ea9f2a">SetName</a>(L<span class="stringliteral">&quot;program-company&quot;</span>);
<a name="l01121"></a>01121                     param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a0b91a700f3a0cad9e04bd443d27f4dc3">SetValueText</a>(StringUtils::ConvertMBSToWCS(<span class="stringliteral">&quot;Affymetrix&quot;</span>));
<a name="l01122"></a>01122                     CHPMDD.GetGenericData().Header().GetGenericDataHdr()-&gt;AddNameValParam(param);
<a name="l01123"></a>01123 
<a name="l01124"></a>01124                     CHPMDD.SetFilename(opts.<a class="code" href="classCanaryOptions.html#a9e2925bcefd1829244322a6fc5ffa3de" title="CHP files to analyze.">chpFiles</a>[k]);
<a name="l01125"></a>01125     
<a name="l01126"></a>01126                     CHPMDD.SetEntryCount(CopyNumberVariationMultiDataType, nregions, max_rlen);
<a name="l01127"></a>01127     
<a name="l01128"></a>01128                     <a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html">FusionCELData</a> celfile;
<a name="l01129"></a>01129                     celfile.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#af43c5c7a95f9f535883c1ddda0bea057">SetFileName</a>(opts.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>[k].c_str());
<a name="l01130"></a>01130                     <span class="keywordflow">if</span> (!celfile.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#aca791993ba594e5a424ece9cd0bfc54e">ReadHeader</a>()) 
<a name="l01131"></a>01131                         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;CEL can&#39;t read header\n&quot;</span>);
<a name="l01132"></a>01132                     <a class="code" href="classaffymetrix__calvin__io_1_1GenericData.html">GenericData</a> * gdata = celfile.<a class="code" href="classaffymetrix__fusion__io_1_1FusionCELData.html#a5fa95da46ae88e9ab8a85e69a73f198d">GetGenericData</a>();
<a name="l01133"></a>01133         
<a name="l01134"></a>01134                     <span class="keywordflow">if</span> (gdata)
<a name="l01135"></a>01135                         CHPMDD.GetFileHeader()-&gt;GetGenericDataHdr()-&gt;
<a name="l01136"></a>01136                             AddParent(*(gdata-&gt;<a class="code" href="classaffymetrix__calvin__io_1_1GenericData.html#aa4dde02ef7050992a36bcd7c2c231c29">Header</a>().GetGenericDataHdr()));
<a name="l01137"></a>01137     
<a name="l01138"></a>01138                     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;hNames.size(); i++) {
<a name="l01139"></a>01139                         param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ac2eb9ad835d3a8845385811f98ea9f2a">SetName</a>(StringUtils::ConvertMBSToWCS(hNames[i]));
<a name="l01140"></a>01140                         param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a0b91a700f3a0cad9e04bd443d27f4dc3">SetValueText</a>(StringUtils::ConvertMBSToWCS(hVals[i]));
<a name="l01141"></a>01141                         params.push_back(param);
<a name="l01142"></a>01142                     }
<a name="l01143"></a>01143 
<a name="l01144"></a>01144                     param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ac2eb9ad835d3a8845385811f98ea9f2a">SetName</a>(StringUtils::ConvertMBSToWCS(<span class="stringliteral">&quot;apt-opt-cel-file&quot;</span>));
<a name="l01145"></a>01145                     param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a0b91a700f3a0cad9e04bd443d27f4dc3">SetValueText</a>(StringUtils::ConvertMBSToWCS(<a class="code" href="classFs.html#a16925724086de1c12ea58bad4f8df75c" title="like the unix function of the same name. ///">Fs::basename</a>(opts.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>[k])));
<a name="l01146"></a>01146                     params.push_back(param);
<a name="l01147"></a>01147     
<a name="l01148"></a>01148                     CHPMDD.AddAlgParams(params);
<a name="l01149"></a>01149     
<a name="l01150"></a>01150                     vector&lt;pair&lt;string, string&gt; &gt; metaData = <a class="code" href="classBaseEngine.html#ac9fb139876b95877fb7412d0dc27cdd8" title="Get a vector of the key=value pairs specified via the &amp;quot;meta-data-info&amp;quot; parameters.">getMetaDataDescription</a>();
<a name="l01151"></a>01151                     ParameterNameValueTypeList appMetaInfoList;
<a name="l01152"></a>01152                     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; metaData.size(); i++) {
<a name="l01153"></a>01153                       pair&lt;string,string&gt; p = metaData[i];
<a name="l01154"></a>01154                       param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#ac2eb9ad835d3a8845385811f98ea9f2a">SetName</a>(StringUtils::ConvertMBSToWCS(p.first));
<a name="l01155"></a>01155                       param.<a class="code" href="classaffymetrix__calvin__parameter_1_1ParameterNameValueType.html#a0b91a700f3a0cad9e04bd443d27f4dc3">SetValueText</a>(StringUtils::ConvertMBSToWCS(p.second));
<a name="l01156"></a>01156                       appMetaInfoList.push_back(param);
<a name="l01157"></a>01157                     }
<a name="l01158"></a>01158                     CHPMDD.AddAppMetaInfo(appMetaInfoList);
<a name="l01159"></a>01159 
<a name="l01160"></a>01160 <span class="comment">//                  this is how a generic parameter is addedwhere the key is not altered</span>
<a name="l01161"></a>01161 <span class="comment">//                          CHPMDD.GetGenericData().Header().GetGenericDataHdr()-&gt;</span>
<a name="l01162"></a>01162 <span class="comment">//                              AddNameValParam(param);</span>
<a name="l01163"></a>01163 
<a name="l01164"></a>01164                     <a class="code" href="classaffymetrix__calvin__io_1_1CHPMultiDataFileWriter.html">CHPMultiDataFileWriter</a> writer(CHPMDD);
<a name="l01165"></a>01165                     writer.SeekToDataSet(CopyNumberVariationMultiDataType);
<a name="l01166"></a>01166    
<a name="l01167"></a>01167                     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;cnv_region_names.size(); i++) {
<a name="l01168"></a>01168                         <span class="keywordflow">if</span> (intensity_map.find(cnv_region_names[i]) != intensity_map.end()) {
<a name="l01169"></a>01169                             <a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataCopyNumberVariationRegionData.html">ProbeSetMultiDataCopyNumberVariationRegionData</a> entry;
<a name="l01170"></a>01170                             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataCopyNumberVariationRegionData.html#a5795ae1874216645ca4be800e2911d82">name</a> = cnv_region_names[i];
<a name="l01171"></a>01171                             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataCopyNumberVariationRegionData.html#abdcd614ecf90c3eff556c61e40c126ae">signal</a> = intensity_map[cnv_region_names[i]][k];
<a name="l01172"></a>01172                             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataCopyNumberVariationRegionData.html#aef7e48f211cc578dba8b022284743025">call</a> = (<span class="keywordtype">unsigned</span> char)call_map[cnv_region_names[i]][k];
<a name="l01173"></a>01173                             entry.<a class="code" href="structaffymetrix__calvin__data_1_1__ProbeSetMultiDataCopyNumberVariationRegionData.html#a3553efebbc0c541d09bf79588eef8f7d">confidenceScore</a> = (float)confidence_map[cnv_region_names[i]][k];
<a name="l01174"></a>01174     
<a name="l01175"></a>01175                             writer.WriteEntry(entry);
<a name="l01176"></a>01176                         }
<a name="l01177"></a>01177                     }
<a name="l01178"></a>01178                 }
<a name="l01179"></a>01179                 <span class="keywordflow">catch</span> (...) {
<a name="l01180"></a>01180                     <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Error writing out chp file &quot;</span> + opts.<a class="code" href="classCanaryOptions.html#a9e2925bcefd1829244322a6fc5ffa3de" title="CHP files to analyze.">chpFiles</a>[k]);
<a name="l01181"></a>01181                 }
<a name="l01182"></a>01182             }<span class="comment">// end for loop over cel files</span>
<a name="l01183"></a>01183             
<a name="l01184"></a>01184             <span class="keywordflow">if</span> (!opts.tableOutput)
<a name="l01185"></a>01185                 <a class="code" href="classFs.html#a6b8f232817f933a42c21edde6ea55a3a" title="An error if it doesnt exist.">Fs::rm</a>(cnvdatafilename, <span class="keyword">false</span>);
<a name="l01186"></a>01186 
<a name="l01187"></a>01187         }<span class="comment">// end if (opts.ccMDChpOutput)</span>
<a name="l01188"></a>01188     }<span class="comment">// end if (output)</span>
<a name="l01189"></a>01189 }
<a name="l01190"></a>01190 
<a name="l01191"></a>01191 <span class="comment">//----------------------------------------------</span>
<a name="l01192"></a>01192 
<a name="l01193"></a>01193 <span class="comment">/*****************************************************************</span>
<a name="l01194"></a>01194 <span class="comment"> *</span>
<a name="l01195"></a>01195 <span class="comment"> * The Engine for Canary.</span>
<a name="l01196"></a>01196 <span class="comment"> *</span>
<a name="l01197"></a>01197 <span class="comment"> *****************************************************************/</span>
<a name="l01198"></a>01198 
<a name="l01199"></a>01199 <span class="keywordtype">void</span> CanaryEngine::CanaryCompute(<a class="code" href="classCanaryOptions.html" title="Place to group program options.">CanaryOptions</a> &amp;opts) {
<a name="l01200"></a>01200     <a class="code" href="classAnalysisStream.html" title="Utility class for centralizing analysis pathway.">AnalysisStream</a> * analysis = NULL;
<a name="l01201"></a>01201     map&lt;string,vector&lt;string&gt; &gt; cnv_region_map;
<a name="l01202"></a>01202     vector&lt;string&gt; cnv_region_names;
<a name="l01203"></a>01203     <span class="keywordflow">try</span> {
<a name="l01204"></a>01204         <span class="comment">// Description of the chip</span>
<a name="l01205"></a>01205         <a class="code" href="classChipLayout.html" title="ChipLayout - Data structure to represent the probesets encoded in the CDF, SPF or PGF files which def...">ChipLayout</a> layout;
<a name="l01206"></a>01206 
<a name="l01207"></a>01207         <span class="comment">// Probeset names in the cdf or spf file.</span>
<a name="l01208"></a>01208         set&lt;string&gt; lib_psets;
<a name="l01209"></a>01209 
<a name="l01210"></a>01210         loadCdfLayout_canary(layout, opts, lib_psets);
<a name="l01211"></a>01211 
<a name="l01212"></a>01212         <span class="comment">// Region file info</span>
<a name="l01213"></a>01213         read_region_file(opts.cnvRegionFile, cnv_region_map, cnv_region_names);
<a name="l01214"></a>01214         set&lt;string&gt;cnv_psets = get_cnv_psets(cnv_region_map);
<a name="l01215"></a>01215 
<a name="l01216"></a>01216         set&lt;string&gt;normalization_psets =
<a name="l01217"></a>01217             get_normalization_psets(opts.cnvNormFile);
<a name="l01218"></a>01218 
<a name="l01219"></a>01219         vector&lt;string&gt;pset_vec = get_available_psets(cnv_psets,
<a name="l01220"></a>01220                                                      normalization_psets,
<a name="l01221"></a>01221                                                      lib_psets,opts);
<a name="l01222"></a>01222 
<a name="l01223"></a>01223         <span class="comment">// Make our analysis from our specifications.</span>
<a name="l01224"></a>01224         <a class="code" href="classAnalysisStreamFactory.html" title="Object for making new analysis streams from a text specification.">AnalysisStreamFactory</a> asFactory(QuantMethodFactory::Expression);
<a name="l01225"></a>01225         analysis = asFactory.constructExpressionAnalysisStream(
<a name="l01226"></a>01226             opts.aptSummarizeAnalysis, layout, opts.stdMethods,
<a name="l01227"></a>01227             opts.setAnalysisName);
<a name="l01228"></a>01228 
<a name="l01229"></a>01229 
<a name="l01230"></a>01230         <span class="comment">// figure out ordering of probes for disk mart</span>
<a name="l01231"></a>01231         vector&lt;int&gt; desiredOrder;
<a name="l01232"></a>01232         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;pset_vec.size(); i++) {
<a name="l01233"></a>01233             <a class="code" href="classProbeListPacked.html">ProbeListPacked</a> pl = layout.<a class="code" href="classChipLayout.html#ae465f92816b1c9983a45d1f73293cc7b" title="Find a probe set using the name as a key.">getProbeListByName</a>(pset_vec[i]);
<a name="l01234"></a>01234             <span class="keywordflow">if</span> (!pl.isNull()) {
<a name="l01235"></a>01235                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> pIx = 0; pIx &lt; pl.probe_cnt(); pIx++) {
<a name="l01236"></a>01236                     desiredOrder.push_back(pl.get_probeId(pIx));
<a name="l01237"></a>01237                 }
<a name="l01238"></a>01238             }
<a name="l01239"></a>01239         }
<a name="l01240"></a>01240         <a class="code" href="classIntensityMart.html" title="IntensityMart.">IntensityMart</a>* iMart = NULL;
<a name="l01241"></a>01241         <span class="comment">// RAM cache for data we&#39;re computing with.</span>
<a name="l01242"></a>01242         <span class="keywordtype">int</span> intensityCacheSize = <a class="code" href="classOptions.html#afcfab86e21cac5bba43e0858bd428e62" title="Get the integer value of an option.">getOptInt</a>(<span class="stringliteral">&quot;disk-cache&quot;</span>) * 1048576;
<a name="l01243"></a>01243         <span class="keywordflow">if</span> (<a class="code" href="classOptions.html#a3c98038375042f9b230b3e4e2151fe00" title="Get the boolean value of an option.">getOptBool</a>(<span class="stringliteral">&quot;use-disk&quot;</span>)) {
<a name="l01244"></a>01244             <a class="code" href="classDiskIntensityMart.html" title="Very simple version of an IntensityMart based directly on cel files for comparison and troubleshootin...">DiskIntensityMart</a>* diskMart = 
<a name="l01245"></a>01245                 <span class="keyword">new</span> <a class="code" href="classDiskIntensityMart.html" title="Very simple version of an IntensityMart based directly on cel files for comparison and troubleshootin...">DiskIntensityMart</a>(desiredOrder, 
<a name="l01246"></a>01246                                       opts.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>,
<a name="l01247"></a>01247                                       intensityCacheSize,
<a name="l01248"></a>01248                                       <a class="code" href="classOptions.html#a0efc7e2a4a55297f0f642d1d8bc08b82" title="Get the value of an option.">getOpt</a>(<span class="stringliteral">&quot;temp-dir&quot;</span>),
<a name="l01249"></a>01249                                       <span class="stringliteral">&quot;apt-canary.tmp&quot;</span>,
<a name="l01250"></a>01250                                       <span class="keyword">true</span>);
<a name="l01251"></a>01251             iMart = diskMart;
<a name="l01252"></a>01252         }
<a name="l01253"></a>01253         <span class="keywordflow">else</span> {
<a name="l01254"></a>01254             <a class="code" href="classSparseMart.html" title="SparseMart Class for representing only a subset of cel file intensity data in memory.">SparseMart</a>* sparseMart = <span class="keyword">new</span> <a class="code" href="classSparseMart.html" title="SparseMart Class for representing only a subset of cel file intensity data in memory.">SparseMart</a>(desiredOrder, 
<a name="l01255"></a>01255                                                     opts.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>, 
<a name="l01256"></a>01256                                                     <span class="keyword">true</span>);
<a name="l01257"></a>01257             iMart = sparseMart;
<a name="l01258"></a>01258         }
<a name="l01259"></a>01259 
<a name="l01260"></a>01260         <a class="code" href="classCelReader.html" title="Class for reading cel files and passing the data to memory representation and analysis objects...">CelReader</a> cReader;
<a name="l01261"></a>01261         cReader.<a class="code" href="classIntensityReader.html#a09f2f97ab0ba20f77f4fba6cc8644a5c" title="Push this chip stream onto the collection that will receive data.">registerStream</a>(analysis-&gt;<a class="code" href="classAnalysisStream.html#a43a654bde9711d1c5501fcf1e58b91af" title="Get the beginning of the chipstream list.">getChipStreamHead</a>());
<a name="l01262"></a>01262         cReader.<a class="code" href="classIntensityReader.html#a0124349ddc9af057e80f05dcd9557deb" title="Set the names of the files to read data from.">setFiles</a>(opts.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>);
<a name="l01263"></a>01263         cReader.<a class="code" href="classIntensityReader.html#abd0311ffde07633f1ecb5dec205732a4" title="Push an intensity mart onto the list of those that should receive data.">registerIntensityMart</a>(iMart);
<a name="l01264"></a>01264 
<a name="l01265"></a>01265         analysis-&gt;<a class="code" href="classAnalysisStream.html#a8d63dff82845395fa2eaaa2a2411b11e" title="Add a reporter that prints to simple tab delimited file for an analysis stream.">addTextReporter</a>(opts.outDir,opts.precision,<span class="keyword">false</span>,<span class="keyword">false</span>);
<a name="l01266"></a>01266 
<a name="l01267"></a>01267         <span class="comment">// Read CEL files</span>
<a name="l01268"></a>01268         cReader.<a class="code" href="classCelReader.html#a9966a326c023b7048e732db3c657913f" title="Do the heavy lifting of reading data from the cel files and passing to all the streams and intensity ...">readFiles</a>();
<a name="l01269"></a>01269         analysis-&gt;prepare(*iMart);
<a name="l01270"></a>01270         <a class="code" href="classAnalysisInfo.html" title="Information about a particular analysis run.">AnalysisInfo</a> info = analysis-&gt;getInfo();
<a name="l01271"></a>01271         vector&lt;pair&lt;string, string&gt; &gt; metaData = <a class="code" href="classBaseEngine.html#ac9fb139876b95877fb7412d0dc27cdd8" title="Get a vector of the key=value pairs specified via the &amp;quot;meta-data-info&amp;quot; parameters.">getMetaDataDescription</a>();
<a name="l01272"></a>01272         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; metaData.size(); i++) {
<a name="l01273"></a>01273           pair&lt;string,string&gt; p = metaData[i];
<a name="l01274"></a>01274           info.<a class="code" href="classAnalysisInfo.html#a9482ae5e2f30e58b5a06d1f689edef59" title="Add client supplied key/value parameter pair to our information.">addClientMetaInfo</a>(p.first, p.second);
<a name="l01275"></a>01275         }
<a name="l01276"></a>01276         analysis-&gt;setInfo(info);
<a name="l01277"></a>01277         analysis-&gt;<a class="code" href="classAnalysisStream.html#acb4fca52e4470197e384151f349c7660" title="Write out the initial text header for a quantification method.">addStdHeaders</a>(layout, opts.execGuid,
<a name="l01278"></a>01278                                 opts.timeStr, opts.commandLine,
<a name="l01279"></a>01279                                 opts.cvsId + <span class="stringliteral">&quot;-&quot;</span> +  opts.version, 
<a name="l01280"></a>01280                                 analysis-&gt;getInfo());
<a name="l01281"></a>01281 
<a name="l01282"></a>01282         <span class="comment">// Actual analysis computation.</span>
<a name="l01283"></a>01283         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;pset_vec.size(); k++) {
<a name="l01284"></a>01284             <a class="code" href="classProbeListPacked.html">ProbeListPacked</a> pList = layout.<a class="code" href="classChipLayout.html#ae465f92816b1c9983a45d1f73293cc7b" title="Find a probe set using the name as a key.">getProbeListByName</a>(pset_vec[k]);
<a name="l01285"></a>01285             <a class="code" href="classProbeSet.html" title="Collection of atoms that measure target that should be absent or present at the same time...">ProbeSet</a>* ps = <a class="code" href="classProbeListFactory.html#aaed559bbfe723ed4fe225f805a2411e8">ProbeListFactory::asProbeSet</a>(pList);
<a name="l01286"></a>01286             <a class="code" href="classProbeSetGroup.html" title="Group of probe sets that should be processed as a single large probe set.">ProbeSetGroup</a> psGroup(ps); <span class="comment">// psGroup will free ps</span>
<a name="l01287"></a>01287             analysis-&gt;<a class="code" href="classAnalysisStream.html#a9ab46236cf214204e2048b5ee2ec12ec" title="Do the analysis for a particular group of probe sets.">doAnalysis</a>(psGroup, *iMart, <span class="keyword">true</span>);
<a name="l01288"></a>01288         }
<a name="l01289"></a>01289     
<a name="l01290"></a>01290         <span class="comment">// Tell analyses that we are done computing.</span>
<a name="l01291"></a>01291         analysis-&gt;finish();
<a name="l01292"></a>01292         <a class="code" href="Util_8h.html#ad0787eda9709999bbd42dc11b21deb0d" title="delete function that deletes the pointer and sets it to NULL.">Freez</a>(iMart);
<a name="l01293"></a>01293     } <span class="comment">// end try</span>
<a name="l01294"></a>01294     <span class="keywordflow">catch</span>(<a class="code" href="classExcept.html" title="General purpose exception error for error handling.">Except</a> &amp;e) {
<a name="l01295"></a>01295         <a class="code" href="Util_8h.html#ad0787eda9709999bbd42dc11b21deb0d" title="delete function that deletes the pointer and sets it to NULL.">Freez</a>(analysis);
<a name="l01296"></a>01296         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(e.<a class="code" href="classExcept.html#a6983a18bbb12fd78301d1ee77b2371ff" title="Standard what() call, just returns error message.">what</a>());
<a name="l01297"></a>01297     }
<a name="l01298"></a>01298     <span class="keywordflow">catch</span>(<span class="keyword">const</span> BaseException &amp;e) {
<a name="l01299"></a>01299         <a class="code" href="Util_8h.html#ad0787eda9709999bbd42dc11b21deb0d" title="delete function that deletes the pointer and sets it to NULL.">Freez</a>(analysis);
<a name="l01300"></a>01300         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;newmat issue: &quot;</span> + <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(e.what()));
<a name="l01301"></a>01301     }
<a name="l01302"></a>01302     <span class="keywordflow">catch</span>(<a class="code" href="classaffymetrix__calvin__exceptions_1_1CalvinException.html">CalvinException</a> &amp;ce) {
<a name="l01303"></a>01303         <a class="code" href="Util_8h.html#ad0787eda9709999bbd42dc11b21deb0d" title="delete function that deletes the pointer and sets it to NULL.">Freez</a>(analysis);
<a name="l01304"></a>01304         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Affymetrix GeneChip Command Console library has thrown an exception. Description: &#39;&quot;</span> + 
<a name="l01305"></a>01305                       StringUtils::ConvertWCSToMBS(ce.<a class="code" href="classaffymetrix__calvin__exceptions_1_1CalvinException.html#a24f3db249eaee80ba1010dcc9e4db3d2">Description</a>()) + <span class="stringliteral">&quot;&#39;&quot;</span>);
<a name="l01306"></a>01306     }
<a name="l01307"></a>01307     <span class="keywordflow">catch</span>(<span class="keyword">const</span> std::bad_alloc &amp;e) {
<a name="l01308"></a>01308         <a class="code" href="Util_8h.html#ad0787eda9709999bbd42dc11b21deb0d" title="delete function that deletes the pointer and sets it to NULL.">Freez</a>(analysis);
<a name="l01309"></a>01309         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Ran out of memory.&quot;</span>);
<a name="l01310"></a>01310     }
<a name="l01311"></a>01311     <span class="keywordflow">catch</span>(<span class="keyword">const</span> std::exception &amp;e) {
<a name="l01312"></a>01312         <a class="code" href="Util_8h.html#ad0787eda9709999bbd42dc11b21deb0d" title="delete function that deletes the pointer and sets it to NULL.">Freez</a>(analysis);
<a name="l01313"></a>01313         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;standard exception: &quot;</span> + <a class="code" href="Convert_8h.html#a9e68e488e4da0371aea30596313537df" title="Little template function to make string conversion easy.">ToStr</a>(e.what()));
<a name="l01314"></a>01314     }
<a name="l01315"></a>01315     <span class="keywordflow">catch</span>(...) {
<a name="l01316"></a>01316         <a class="code" href="Util_8h.html#ad0787eda9709999bbd42dc11b21deb0d" title="delete function that deletes the pointer and sets it to NULL.">Freez</a>(analysis);
<a name="l01317"></a>01317         <a class="code" href="classErr.html#a121c0cbb1687c93444a1b5f7f6ea56af" title="Print the message supplied and abort program.">Err::errAbort</a>(<span class="stringliteral">&quot;Uncaught Exception.&quot;</span>);
<a name="l01318"></a>01318     }
<a name="l01319"></a>01319     <span class="comment">/* Cleanup. */</span>
<a name="l01320"></a>01320     <a class="code" href="Util_8h.html#ad0787eda9709999bbd42dc11b21deb0d" title="delete function that deletes the pointer and sets it to NULL.">Freez</a>(analysis);
<a name="l01321"></a>01321 
<a name="l01322"></a>01322     <span class="comment">// Reading and writing temporary files here because of the merging</span>
<a name="l01323"></a>01323     averageAlleles(opts);
<a name="l01324"></a>01324     writeCnvSummaries(opts,cnv_region_map);
<a name="l01325"></a>01325         
<a name="l01326"></a>01326     <span class="comment">// Check to see if the output cnv file names are there</span>
<a name="l01327"></a>01327     <span class="keywordflow">if</span> (!opts.<a class="code" href="classCanaryOptions.html#a9e2925bcefd1829244322a6fc5ffa3de" title="CHP files to analyze.">chpFiles</a>.size()) {
<a name="l01328"></a>01328         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k=0; k&lt;opts.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>.size(); k++) {
<a name="l01329"></a>01329             <span class="keywordtype">string</span> chpfname = <a class="code" href="classFs.html#a16925724086de1c12ea58bad4f8df75c" title="like the unix function of the same name. ///">Fs::basename</a>(opts.<a class="code" href="classCanaryOptions.html#aaaafb53ec3887ae8a7c1f1f6d3caf9e0" title="Cel files to analyze.">celFiles</a>[k]);
<a name="l01330"></a>01330             chpfname = swap_suffix(chpfname,<span class="stringliteral">&quot;.&quot;</span> + opts.setAnalysisName + 
<a name="l01331"></a>01331                                    <span class="stringliteral">&quot;.cnvchp&quot;</span>);
<a name="l01332"></a>01332             chpfname = <a class="code" href="classFs.html#af44351abee4cbc47f94b83cb2f62899f" title="join strings with the path sep. /// while we would want people to keep the path with FsPath...">Fs::join</a>(opts.outDir,chpfname);
<a name="l01333"></a>01333             opts.<a class="code" href="classCanaryOptions.html#a9e2925bcefd1829244322a6fc5ffa3de" title="CHP files to analyze.">chpFiles</a>.push_back(chpfname);
<a name="l01334"></a>01334         }
<a name="l01335"></a>01335     }
<a name="l01336"></a>01336 
<a name="l01337"></a>01337     mainCanary(opts,cnv_region_map,cnv_region_names);
<a name="l01338"></a>01338 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Wed Mar 23 2016 12:58:48 for Affymetrix Power Tools by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
